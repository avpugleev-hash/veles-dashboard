<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // ==========================
    // 1. –ù–ê–°–¢–†–û–ô–ö–ê GOOGLE SHEETS
    // ==========================
    // –õ–∏—Å—Ç raw_data –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –∫–∞–∫ CSV –ø–æ —ç—Ç–æ–π —Å—Å—ã–ª–∫–µ:
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRy08FvutySDNk8yvn0QKdT92-uWjRqaxqi2057Tl42Ai2zLS4L833E2g2GdgBnpFX-t5uwX6JUcmg4/pub?output=csv';

    let dashboardData = null;
    let trendChart = null;

    // ==========================
    // 2. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
    // ==========================

    function toNumber(value) {
        if (value === undefined || value === null || value === '') return 0;
        const normalized = String(value).replace(/\s+/g, '').replace(',', '.');
        const n = Number(normalized);
        return isNaN(n) ? 0 : n;
    }

    function parseCSV(csvText) {
        return csvText
            .trim()
            .split('\n')
            .map(row => row.split(',').map(cell => cell.trim()));
    }

    function parseDate(dateStr) {
        if (!dateStr) return null;

        // –§–æ—Ä–º–∞—Ç YYYY-MM-DD
        const iso = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (iso) {
            const [, y, m, d] = iso;
            return new Date(Number(y), Number(m) - 1, Number(d));
        }

        // –§–æ—Ä–º–∞—Ç DD.MM.YYYY
        const ru = dateStr.match(/^(\d{2})\.(\d{2})\.(\d{4})/);
        if (ru) {
            const [, d, m, y] = ru;
            return new Date(Number(y), Number(m) - 1, Number(d));
        }

        const d = new Date(dateStr);
        return isNaN(d.getTime()) ? null : d;
    }

    function startOfDay(d) {
        return new Date(d.getFullYear(), d.getMonth(), d.getDate());
    }

    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫–∏ raw_data –≤ –æ–±—ä–µ–∫—Ç—ã
    function rowsToObjects(rows) {
        if (!rows.length) return [];

        const header = rows[0];

        const idxTimestamp   = header.indexOf('timestamp');
        const idxLoaded      = header.indexOf('loaded_wagons');
        const idxPlanned     = header.indexOf('planned_wagons');
        const idxTotalDebt   = header.indexOf('total_debt');
        const idxOverdueDebt = header.indexOf('overdue_debt');
        const idxTr          = header.indexOf('tr_count');
        const idxKr          = header.indexOf('kr_count');
        const idxTor         = header.indexOf('tor_count');
        const idxFleet       = header.indexOf('fleet_total'); // –º–æ–∂–µ—Ç –±—ã—Ç—å -1, –µ—Å–ª–∏ –Ω–µ—Ç —Å—Ç–æ–ª–±—Ü–∞

        const result = [];

        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            if (!row[idxTimestamp]) continue;

            const date = parseDate(row[idxTimestamp]);
            if (!date) continue;

            result.push({
                date,
                timestamp: row[idxTimestamp],
                loaded_wagons: toNumber(idxLoaded      !== -1 ? row[idxLoaded]      : 0),
                planned_wagons: toNumber(idxPlanned    !== -1 ? row[idxPlanned]    : 0),
                total_debt:     toNumber(idxTotalDebt  !== -1 ? row[idxTotalDebt]  : 0),
                overdue_debt:   toNumber(idxOverdueDebt!== -1 ? row[idxOverdueDebt]: 0),
                tr_count:       toNumber(idxTr         !== -1 ? row[idxTr]         : 0),
                kr_count:       toNumber(idxKr         !== -1 ? row[idxKr]         : 0),
                tor_count:      toNumber(idxTor        !== -1 ? row[idxTor]        : 0),
                fleet_total:    toNumber(idxFleet      !== -1 ? row[idxFleet]      : 0)
            });
        }

        return result;
    }

    // ==========================
    // 3. –ü–û–°–¢–†–û–ï–ù–ò–ï dashboardData
    // ==========================

    function buildDashboardDataFromRaw(rowObjs) {
        if (!rowObjs.length) {
            return {
                loading: {
                    loaded_wagons_month: 0,
                    planned_wagons_today: 0,
                    loaded_wagons_yesterday: 0,
                    plan_month: 0,
                    progress_percent: 0
                },
                receivables: {
                    total_debt: 0,
                    overdue_debt: 0,
                    overdue_percent: 0
                },
                repairs: {
                    tr_count: 0,
                    kr_count: 0,
                    tor_count: 0,
                    fleet_total: 0,
                    tr_percent: 0,
                    kr_percent: 0,
                    tor_percent: 0
                },
                daily_trend: [],
                last_update: ''
            };
        }

        const today = startOfDay(new Date());
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

        // –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ —ç—Ç–æ–≥–æ –º–µ—Å—è—Ü–∞ —Å 1-–≥–æ –ø–æ –≤—á–µ—Ä–∞ –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ
        const rowsThisMonth = rowObjs.filter(r => {
            const d = startOfDay(r.date);
            return d >= monthStart && d <= yesterday;
        });

        const loadedMonth = rowsThisMonth.reduce((sum, r) => sum + (r.loaded_wagons || 0), 0);
        const planMonth   = rowsThisMonth.reduce((sum, r) => sum + (r.planned_wagons || 0), 0);

        const rowYesterday = rowObjs.find(r => startOfDay(r.date).getTime() === yesterday.getTime());
        const loadedYesterday = rowYesterday ? rowYesterday.loaded_wagons : 0;

        const rowToday = rowObjs.find(r => startOfDay(r.date).getTime() === today.getTime());
        const plannedToday = rowToday ? rowToday.planned_wagons : 0;

        const sorted = rowObjs.slice().sort((a, b) => a.date - b.date);
        const lastRow = sorted[sorted.length - 1];

        const totalDebt = lastRow.total_debt || 0;
        const overdueDebt = lastRow.overdue_debt || 0;
        const overduePercent = totalDebt ? Math.round(overdueDebt / totalDebt * 100) : 0;

        const fleetTotal = lastRow.fleet_total || 2000;

        const tr = lastRow.tr_count || 0;
        const kr = lastRow.kr_count || 0;
        const tor = lastRow.tor_count || 0;

        const trPercent  = fleetTotal ? Math.round(tr  / fleetTotal * 100) : 0;
        const krPercent  = fleetTotal ? Math.round(kr  / fleetTotal * 100) : 0;
        const torPercent = fleetTotal ? Math.round(tor / fleetTotal * 100) : 0;

        const last7 = sorted.slice(-7);
        const dailyTrend = last7.map(r => {
            const d = r.date;
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            return {
                label: `${dd}.${mm}`,
                wagons: r.loaded_wagons
            };
        });

        return {
            loading: {
                loaded_wagons_month: loadedMonth,
                planned_wagons_today: plannedToday,
                loaded_wagons_yesterday: loadedYesterday,
                plan_month: planMonth,
                progress_percent: planMonth ? Math.round(loadedMonth / planMonth * 100) : 0
            },
            receivables: {
                total_debt: totalDebt,
                overdue_debt: overdueDebt,
                overdue_percent: overduePercent
            },
            repairs: {
                tr_count: tr,
                kr_count: kr,
                tor_count: tor,
                fleet_total: fleetTotal,
                tr_percent: trPercent,
                kr_percent: krPercent,
                tor_percent: torPercent
            },
            daily_trend: dailyTrend,
            last_update: lastRow.timestamp
        };
    }

    async function loadDataFromRawSheet() {
        const res = await fetch(SHEET_CSV_URL);
        const csvText = await res.text();
        const rows = parseCSV(csvText);
        const rowObjs = rowsToObjects(rows);
        dashboardData = buildDashboardDataFromRaw(rowObjs);
    }

    // ==========================
    // 4. –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï / –í–†–ï–ú–Ø
    // ==========================

    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }

    function formatCurrency(amount) {
        const millions = (amount / 1000000).toFixed(1);
        return `${millions} –º–ª–Ω. —Ä.`;
    }

    function updateDateTime() {
        const now = new Date();
        const options = {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        };
        document.getElementById('currentDateTime').textContent = 
            now.toLocaleDateString('ru-RU', options);
    }

    // ==========================
    // 5. –ó–ê–ü–û–õ–ù–ï–ù–ò–ï –ö–ê–†–¢–û–ß–ï–ö
    // ==========================

    function populateDashboard() {
        if (!dashboardData) return;

        // Loading
        document.getElementById('loadedWagonsMonth').textContent = 
            formatNumber(dashboardData.loading.loaded_wagons_month);
        document.getElementById('progressPercent').textContent = 
            `${dashboardData.loading.progress_percent}%`;
        document.getElementById('progressFill').style.width = 
            `${dashboardData.loading.progress_percent}%`;
        document.getElementById('planMonth').textContent = 
            formatNumber(dashboardData.loading.plan_month);
        document.getElementById('loadedYesterday').textContent = 
            formatNumber(dashboardData.loading.loaded_wagons_yesterday);

        // Receivables
        document.getElementById('totalDebt').textContent = 
            formatCurrency(dashboardData.receivables.total_debt);
        document.getElementById('overdueDebt').textContent = 
            formatCurrency(dashboardData.receivables.overdue_debt);
        document.getElementById('overduePercent').textContent = 
            `${dashboardData.receivables.overdue_percent}%`;
        document.getElementById('overdueProgressFill').style.width = 
            `${dashboardData.receivables.overdue_percent}%`;

        // Repairs
        document.getElementById('repairTR').textContent = 
            dashboardData.repairs.tr_count;
        document.getElementById('repairTRPercent').textContent = 
            `${dashboardData.repairs.tr_percent}% –æ—Ç –ø–∞—Ä–∫–∞`;
        document.getElementById('repairKR').textContent = 
            dashboardData.repairs.kr_count;
        document.getElementById('repairKRPercent').textContent = 
            `${dashboardData.repairs.kr_percent}% –æ—Ç –ø–∞—Ä–∫–∞`;
        document.getElementById('repairTOR').textContent = 
            dashboardData.repairs.tor_count;
        document.getElementById('repairTORPercent').textContent = 
            `${dashboardData.repairs.tor_percent}% –æ—Ç –ø–∞—Ä–∫–∞`;
        document.getElementById('fleetTotal').textContent = 
            formatNumber(dashboardData.repairs.fleet_total);

        // Last update
        document.getElementById('lastUpdate').textContent = dashboardData.last_update || '‚Äî';
    }

    // ==========================
    // 6. –ì–†–ê–§–ò–ö
    // ==========================

    function createTrendChart() {
        const ctx = document.getElementById('trendChart').getContext('2d');

        if (trendChart) {
            trendChart.destroy();
        }

        const labels = dashboardData.daily_trend.map(d => d.label);
        const data = dashboardData.daily_trend.map(d => d.wagons);

        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '–ü–æ–≥—Ä—É–∂–µ–Ω–æ –≤–∞–≥–æ–Ω–æ–≤',
                    data: data,
                    borderColor: '#20b2aa',
                    backgroundColor: 'rgba(32, 178, 170, 0.1)',
                    borderWidth: 3,
                    tension: 0.3,
                    fill: true,
                    pointBackgroundColor: '#20b2aa',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return '–í–∞–≥–æ–Ω–æ–≤: ' + formatNumber(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            callback: function(value) {
                                return formatNumber(value);
                            }
                        }
                    }
                }
            }
        });
    }

    // ==========================
    // 7. –û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–•
    // ==========================

    async function refreshData() {
        const btn = document.querySelector('.refresh-btn');
        if (btn) btn.disabled = true;

        try {
            await loadDataFromRawSheet();
            populateDashboard();
            createTrendChart();

            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            const ss = String(now.getSeconds()).padStart(2, '0');

            if (!dashboardData.last_update) {
                document.getElementById('lastUpdate').textContent =
                    `${y}-${m}-${d} ${hh}:${mm}:${ss}`;
            }

            if (btn) {
                btn.textContent = '‚úì –û–±–Ω–æ–≤–ª–µ–Ω–æ!';
                setTimeout(() => {
                    btn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
                    btn.disabled = false;
                }, 2000);
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', e);
            if (btn) {
                btn.textContent = '–û—à–∏–±–∫–∞ üòï';
                setTimeout(() => {
                    btn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
                    btn.disabled = false;
                }, 3000);
            }
        }
    }

    // ==========================
    // 8. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // ==========================

    async function initDashboard() {
        updateDateTime();
        setInterval(updateDateTime, 1000);

        try {
            await loadDataFromRawSheet();
            populateDashboard();
            createTrendChart();

            // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç:
            // setInterval(refreshData, 5 * 60 * 1000);
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞—à–±–æ—Ä–¥–∞:', e);
        }
    }

    document.addEventListener('DOMContentLoaded', initDashboard);
</script>
