<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞—à–±–æ—Ä–¥ | –û–û–û "–¢–ö –í–ï–õ–ï–°"</title>
    <style>
        :root {
          --navy-primary: #1a2a4a;
          --navy-dark: #0f1a2e;
          --gold-accent: #d4a574;
          --gray-secondary: #4a5568;
          --success-green: #20b2aa;
          --warning-orange: #e8622b;
          --bg-light: #f7f8fa;
          --bg-card: #ffffff;
          --text-primary: #1a2a4a;
          --text-secondary: #6b7280;
          --border-color: #e5e7eb;
          --radius-base: 8px;
          --radius-lg: 14px;
          --radius-full: 999px;
          --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.08);
          --font-family-base: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family-base);
            background: var(--bg-light);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .dashboard-header {
            background: linear-gradient(135deg, var(--navy-primary), var(--navy-dark));
            color: #fff;
            padding: 24px 28px;
            border-radius: 18px;
            margin-bottom: 28px;
            box-shadow: 0 12px 32px rgba(15, 26, 46, 0.4);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .company-info h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .company-info .subtitle {
            font-size: 14px;
            opacity: 0.85;
        }

        .header-right {
            text-align: right;
        }

        .current-datetime {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .last-update {
            font-size: 12px;
            opacity: 0.85;
            display: flex;
            align-items: center;
            gap: 6px;
            justify-content: flex-end;
        }

        .refresh-btn {
            margin-top: 10px;
            padding: 8px 18px;
            border-radius: var(--radius-full);
            border: none;
            background: var(--gold-accent);
            color: var(--navy-primary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(212, 165, 116, 0.6);
            transition: transform 0.15s, box-shadow 0.15s, background 0.15s;
        }

        .refresh-btn:hover {
            background: #c89860;
            transform: translateY(-1px);
        }

        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: default;
            box-shadow: none;
        }

        /* Cards */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: var(--bg-card);
            padding: 18px 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border-color);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 14px;
        }

        .card-icon {
            font-size: 26px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 0.04em;
        }

        .card-body {
            font-size: 13px;
        }

        .main-metric {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .metric-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .progress-section {
            margin: 10px 0 6px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 6px;
        }

        .progress-label {
            color: var(--text-secondary);
        }

        .progress-value {
            font-weight: 600;
            color: var(--success-green);
        }

        .progress-bar {
            width: 100%;
            height: 7px;
            border-radius: var(--radius-full);
            background: #e5e7eb;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            width: 0;
            border-radius: var(--radius-full);
            background: linear-gradient(90deg, var(--success-green), var(--gold-accent));
            transition: width 0.4s ease-out;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, var(--warning-orange), #ff9a62);
        }

        .secondary-metrics {
            margin-top: 10px;
            border-top: 1px solid var(--border-color);
            padding-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .secondary-metric {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }

        .secondary-metric-label {
            color: var(--text-secondary);
        }

        .secondary-metric-value {
            font-weight: 600;
        }

        .debt-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .debt-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .debt-value {
            font-size: 20px;
            font-weight: 700;
        }

        .debt-value.total {
            color: var(--text-primary);
        }

        .debt-value.overdue {
            color: var(--warning-orange);
        }

        .repair-breakdown {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .repair-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f3f4f6;
            padding: 8px 10px;
            border-radius: 10px;
            border-left: 4px solid var(--navy-primary);
        }

        .repair-item:nth-child(1) { border-left-color: var(--success-green); }
        .repair-item:nth-child(2) { border-left-color: var(--warning-orange); }
        .repair-item:nth-child(3) { border-left-color: var(--gold-accent); }

        .repair-type {
            font-size: 13px;
            font-weight: 600;
        }

        .repair-description {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .repair-stats {
            text-align: right;
        }

        .repair-count {
            font-size: 20px;
            font-weight: 700;
        }

        .repair-percent {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Chart */
        .chart-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 18px 20px;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border-color);
        }

        .chart-header {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 700;
        }

        .chart-container {
            height: 280px;
            position: relative;
        }

        @media (max-width: 768px) {
            .dashboard-header {
                padding: 18px;
            }
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            .header-right {
                text-align: left;
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="dashboard-container">
    <!-- HEADER -->
    <header class="dashboard-header">
        <div class="header-content">
            <div class="company-info">
                <h1>–û–û–û "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –ö–æ–º–ø–∞–Ω–∏—è ¬´–í–ï–õ–ï–°¬ª"</h1>
                <p class="subtitle">–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –¥–∞—à–±–æ—Ä–¥</p>
            </div>
            <div class="header-right">
                <div class="current-datetime" id="currentDateTime">‚Äî</div>
                <div class="last-update">
                    <span>‚è±</span>
                    <span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="lastUpdate">‚Äî</span></span>
                </div>
                <button class="refresh-btn" onclick="refreshData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
            </div>
        </div>
    </header>

    <!-- METRICS -->
    <div class="metrics-grid">
        <!-- –ü–û–ì–†–£–ó–ö–ê -->
        <div class="metric-card">
            <div class="card-header">
                <div class="card-icon">üì¶</div>
                <div class="card-title">–ü–û–ì–†–£–ó–ö–ê</div>
            </div>
            <div class="card-body">
                <div class="main-metric" id="loadedWagonsMonth">‚Äî</div>
                <div class="metric-label">–ü–æ–≥—Ä—É–∂–µ–Ω–æ –≤–∞–≥–æ–Ω–æ–≤ (–º–µ—Å—è—Ü)</div>

                <div class="progress-section">
                    <div class="progress-info">
                        <span class="progress-label">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞</span>
                        <span class="progress-value" id="progressPercent">‚Äî</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <div class="secondary-metrics">
                    <div class="secondary-metric">
                        <span class="secondary-metric-label">–ü–ª–∞–Ω –Ω–∞ –º–µ—Å—è—Ü:</span>
                        <span class="secondary-metric-value" id="planMonth">‚Äî</span>
                    </div>
                    <div class="secondary-metric">
                        <span class="secondary-metric-label">–í—á–µ—Ä–∞ –ø–æ–≥—Ä—É–∂–µ–Ω–æ:</span>
                        <span class="secondary-metric-value" id="loadedYesterday">‚Äî</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨ -->
        <div class="metric-card">
            <div class="card-header">
                <div class="card-icon">üí≥</div>
                <div class="card-title">–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨</div>
            </div>
            <div class="card-body">
                <div class="debt-item">
                    <span class="debt-label">–û–±—â–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å:</span>
                    <span class="debt-value total" id="totalDebt">‚Äî</span>
                </div>
                <div class="debt-item">
                    <span class="debt-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è:</span>
                    <span class="debt-value overdue" id="overdueDebt">‚Äî</span>
                </div>

                <div class="progress-section">
                    <div class="progress-info">
                        <span class="progress-label">–î–æ–ª—è –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–π</span>
                        <span class="progress-value" id="overduePercent" style="color: var(--warning-orange);">‚Äî</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill warning" id="overdueProgressFill"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –†–ï–ú–û–ù–¢–´ -->
        <div class="metric-card">
            <div class="card-header">
                <div class="card-icon">üîß</div>
                <div class="card-title">–†–ï–ú–û–ù–¢–´</div>
            </div>
            <div class="card-body">
                <div class="repair-breakdown">
                    <div class="repair-item">
                        <div>
                            <div class="repair-type">–¢–†</div>
                            <div class="repair-description">–¢–µ–∫—É—â–∏–π —Ä–µ–º–æ–Ω—Ç</div>
                        </div>
                        <div class="repair-stats">
                            <div class="repair-count" id="repairTR">‚Äî</div>
                            <div class="repair-percent" id="repairTRPercent">‚Äî</div>
                        </div>
                    </div>

                    <div class="repair-item">
                        <div>
                            <div class="repair-type">–ö–†</div>
                            <div class="repair-description">–ö–∞–ø–∏—Ç–∞–ª—å–Ω—ã–π —Ä–µ–º–æ–Ω—Ç</div>
                        </div>
                        <div class="repair-stats">
                            <div class="repair-count" id="repairKR">‚Äî</div>
                            <div class="repair-percent" id="repairKRPercent">‚Äî</div>
                        </div>
                    </div>

                    <div class="repair-item">
                        <div>
                            <div class="repair-type">–¢–û–†</div>
                            <div class="repair-description">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</div>
                        </div>
                        <div class="repair-stats">
                            <div class="repair-count" id="repairTOR">‚Äî</div>
                            <div class="repair-percent" id="repairTORPercent">‚Äî</div>
                        </div>
                    </div>
                </div>

                <div class="secondary-metrics">
                    <div class="secondary-metric">
                        <span class="secondary-metric-label">–í—Å–µ–≥–æ –≤–∞–≥–æ–Ω–æ–≤ –≤ –ø–∞—Ä–∫–µ:</span>
                        <span class="secondary-metric-value" id="fleetTotal">‚Äî</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CHART -->
    <div class="chart-section">
        <div class="chart-header">
            <div class="chart-title">–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ–≥—Ä—É–∑–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</div>
        </div>
        <div class="chart-container">
            <canvas id="trendChart"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
'use strict';

///////////////////////////
// 1. –ù–ê–°–¢–†–û–ô–ö–ê –°–°–´–õ–ö–ò
///////////////////////////

// –¢–≤–æ—è –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞ (CSV):
// –í–ê–ñ–ù–û: –∏–º–µ–Ω–Ω–æ —Å "pub?output=csv" –≤ –∫–æ–Ω—Ü–µ.
const SHEET_CSV_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRy08FvutySDNk8yvn0QKdT92-uWjRqaxqi2057Tl42Ai2zLS4L833E2g2GdgBnpFX-t5uwX6JUcmg4/pub?output=csv';

let dashboardData = null;
let trendChart = null;

///////////////////////////
// 2. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï
///////////////////////////
function toNumber(value) {
    if (value === undefined || value === null || value === '') return 0;
    const normalized = String(value).replace(/\s+/g, '').replace(',', '.');
    const n = Number(normalized);
    return isNaN(n) ? 0 : n;
}

function parseCSV(csvText) {
    const lines = csvText.trim().split(/\r?\n/);
    return lines.map(line => line.split(',').map(c => c.trim()));
}

function parseDate(dateStr) {
    if (!dateStr) return null;

    // YYYY-MM-DD
    let m = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (m) {
        const [, y, mo, d] = m;
        return new Date(Number(y), Number(mo) - 1, Number(d));
    }

    // DD.MM.YYYY
    m = dateStr.match(/^(\d{2})\.(\d{2})\.(\d{4})/);
    if (m) {
        const [, d, mo, y] = m;
        return new Date(Number(y), Number(mo) - 1, Number(d));
    }

    const d = new Date(dateStr);
    return isNaN(d.getTime()) ? null : d;
}

function startOfDay(d) {
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}

function rowsToObjects(rows) {
    if (!rows.length) return [];

    const header = rows[0];
    const idxTimestamp   = header.indexOf('timestamp');
    const idxLoaded      = header.indexOf('loaded_wagons');
    const idxPlanned     = header.indexOf('planned_wagons');
    const idxTotalDebt   = header.indexOf('total_debt');
    const idxOverdueDebt = header.indexOf('overdue_debt');
    const idxTr          = header.indexOf('tr_count');
    const idxKr          = header.indexOf('kr_count');
    const idxTor         = header.indexOf('tor_count');
    const idxFleet       = header.indexOf('fleet_total');

    const result = [];

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (!row[idxTimestamp]) continue;

        const date = parseDate(row[idxTimestamp]);
        if (!date) continue;

        result.push({
            date,
            timestamp: row[idxTimestamp],
            loaded_wagons: toNumber(idxLoaded      !== -1 ? row[idxLoaded]      : 0),
            planned_wagons: toNumber(idxPlanned    !== -1 ? row[idxPlanned]    : 0),
            total_debt:     toNumber(idxTotalDebt  !== -1 ? row[idxTotalDebt]  : 0),
            overdue_debt:   toNumber(idxOverdueDebt!== -1 ? row[idxOverdueDebt]: 0),
            tr_count:       toNumber(idxTr         !== -1 ? row[idxTr]         : 0),
            kr_count:       toNumber(idxKr         !== -1 ? row[idxKr]         : 0),
            tor_count:      toNumber(idxTor        !== -1 ? row[idxTor]        : 0),
            fleet_total:    toNumber(idxFleet      !== -1 ? row[idxFleet]      : 0)
        });
    }

    return result;
}

function buildDashboardDataFromRaw(rowObjs) {
    if (!rowObjs.length) {
        return {
            loading: {
                loaded_wagons_month: 0,
                planned_wagons_today: 0,
                loaded_wagons_yesterday: 0,
                plan_month: 0,
                progress_percent: 0
            },
            receivables: {
                total_debt: 0,
                overdue_debt: 0,
                overdue_percent: 0
            },
            repairs: {
                tr_count: 0,
                kr_count: 0,
                tor_count: 0,
                fleet_total: 0,
                tr_percent: 0,
                kr_percent: 0,
                tor_percent: 0
            },
            daily_trend: [],
            last_update: ''
        };
    }

    const today = startOfDay(new Date());
    const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);
    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

    const rowsThisMonth = rowObjs.filter(r => {
        const d = startOfDay(r.date);
        return d >= monthStart && d <= yesterday;
    });

    const loadedMonth = rowsThisMonth.reduce((sum, r) => sum + (r.loaded_wagons || 0), 0);
    const planMonth   = rowsThisMonth.reduce((sum, r) => sum + (r.planned_wagons || 0), 0);

    const rowYesterday = rowObjs.find(r => startOfDay(r.date).getTime() === yesterday.getTime());
    const loadedYesterday = rowYesterday ? rowYesterday.loaded_wagons : 0;

    const rowToday = rowObjs.find(r => startOfDay(r.date).getTime() === today.getTime());
    const plannedToday = rowToday ? rowToday.planned_wagons : 0;

    const sorted = rowObjs.slice().sort((a, b) => a.date - b.date);
    const lastRow = sorted[sorted.length - 1];

    const totalDebt = lastRow.total_debt || 0;
    const overdueDebt = lastRow.overdue_debt || 0;
    const overduePercent = totalDebt ? Math.round(overdueDebt / totalDebt * 100) : 0;

    const fleetTotal = lastRow.fleet_total || 2000;

    const tr = lastRow.tr_count || 0;
    const kr = lastRow.kr_count || 0;
    const tor = lastRow.tor_count || 0;

    const trPercent  = fleetTotal ? Math.round(tr  / fleetTotal * 100) : 0;
    const krPercent  = fleetTotal ? Math.round(kr  / fleetTotal * 100) : 0;
    const torPercent = fleetTotal ? Math.round(tor / fleetTotal * 100) : 0;

    const last7 = sorted.slice(-7);
    const dailyTrend = last7.map(r => {
        const d = r.date;
        const dd = String(d.getDate()).padStart(2, '0');
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        return {
            label: `${dd}.${mm}`,
            wagons: r.loaded_wagons
        };
    });

    return {
        loading: {
            loaded_wagons_month: loadedMonth,
            planned_wagons_today: plannedToday,
            loaded_wagons_yesterday: loadedYesterday,
            plan_month: planMonth,
            progress_percent: planMonth ? Math.round(loadedMonth / planMonth * 100) : 0
        },
        receivables: {
            total_debt: totalDebt,
            overdue_debt: overdueDebt,
            overdue_percent: overduePercent
        },
        repairs: {
            tr_count: tr,
            kr_count: kr,
            tor_count: tor,
            fleet_total: fleetTotal,
            tr_percent: trPercent,
            kr_percent: krPercent,
            tor_percent: torPercent
        },
        daily_trend: dailyTrend,
        last_update: lastRow.timestamp
    };
}

async function loadDataFromSheet() {
    const res = await fetch(SHEET_CSV_URL);
    if (!res.ok) {
        throw new Error('HTTP ' + res.status);
    }
    const csvText = await res.text();
    const rows = parseCSV(csvText);
    const rowObjs = rowsToObjects(rows);
    dashboardData = buildDashboardDataFromRaw(rowObjs);
}

///////////////////////////
// 3. –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï
///////////////////////////
function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
}

function formatCurrency(amount) {
    const millions = (amount / 1_000_000).toFixed(1);
    return `${millions} –º–ª–Ω. —Ä.`;
}

function updateDateTime() {
    const now = new Date();
    const options = {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    };
    document.getElementById('currentDateTime').textContent =
        now.toLocaleDateString('ru-RU', options);
}

///////////////////////////
// 4. –û–ë–ù–û–í–õ–ï–ù–ò–ï DOM
///////////////////////////
function populateDashboard() {
    if (!dashboardData) return;

    document.getElementById('loadedWagonsMonth').textContent =
        formatNumber(dashboardData.loading.loaded_wagons_month);
    document.getElementById('progressPercent').textContent =
        `${dashboardData.loading.progress_percent}%`;
    document.getElementById('progressFill').style.width =
        `${dashboardData.loading.progress_percent}%`;
    document.getElementById('planMonth').textContent =
        formatNumber(dashboardData.loading.plan_month);
    document.getElementById('loadedYesterday').textContent =
        formatNumber(dashboardData.loading.loaded_wagons_yesterday);

    document.getElementById('totalDebt').textContent =
        formatCurrency(dashboardData.receivables.total_debt);
    document.getElementById('overdueDebt').textContent =
        formatCurrency(dashboardData.receivables.overdue_debt);
    document.getElementById('overduePercent').textContent =
        `${dashboardData.receivables.overdue_percent}%`;
    document.getElementById('overdueProgressFill').style.width =
        `${dashboardData.receivables.overdue_percent}%`;

    document.getElementById('repairTR').textContent =
        dashboardData.repairs.tr_count;
    document.getElementById('repairTRPercent').textContent =
        `${dashboardData.repairs.tr_percent}% –æ—Ç –ø–∞—Ä–∫–∞`;
    document.getElementById('repairKR').textContent =
        dashboardData.repairs.kr_count;
    document.getElementById('repairKRPercent').textContent =
        `${dashboardData.repairs.kr_percent}% –æ—Ç –ø–∞—Ä–∫–∞`;
    document.getElementById('repairTOR').textContent =
        dashboardData.repairs.tor_count;
    document.getElementById('repairTORPercent').textContent =
        `${dashboardData.repairs.tor_percent}% –æ—Ç –ø–∞—Ä–∫–∞`;
    document.getElementById('fleetTotal').textContent =
        formatNumber(dashboardData.repairs.fleet_total);

    document.getElementById('lastUpdate').textContent =
        dashboardData.last_update || '‚Äî';
}

///////////////////////////
// 5. –ì–†–ê–§–ò–ö
///////////////////////////
function createTrendChart() {
    const ctx = document.getElementById('trendChart').getContext('2d');

    if (trendChart) {
        trendChart.destroy();
    }

    const labels = dashboardData.daily_trend.map(d => d.label);
    const data = dashboardData.daily_trend.map(d => d.wagons);

    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: '–ü–æ–≥—Ä—É–∂–µ–Ω–æ –≤–∞–≥–æ–Ω–æ–≤',
                data,
                borderColor: '#20b2aa',
                backgroundColor: 'rgba(32, 178, 170, 0.12)',
                borderWidth: 3,
                tension: 0.3,
                fill: true,
                pointBackgroundColor: '#20b2aa',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true, position: 'top' },
                tooltip: {
                    callbacks: {
                        label: ctx => '–í–∞–≥–æ–Ω–æ–≤: ' + formatNumber(ctx.parsed.y)
                    }
                }
            },
            scales: {
                y: {
                    ticks: {
                        callback: value => formatNumber(value)
                    }
                }
            }
        }
    });
}

///////////////////////////
// 6. –û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–•
///////////////////////////
async function refreshData() {
    const btn = document.querySelector('.refresh-btn');
    if (btn) btn.disabled = true;

    try {
        await loadDataFromSheet();
        populateDashboard();
        createTrendChart();

        if (btn) {
            btn.textContent = '‚úì –û–±–Ω–æ–≤–ª–µ–Ω–æ!';
            setTimeout(() => {
                btn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
                btn.disabled = false;
            }, 1500);
        }
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', e);
        document.getElementById('lastUpdate').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
        if (btn) {
            btn.textContent = '–û—à–∏–±–∫–∞ üòï';
            setTimeout(() => {
                btn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
                btn.disabled = false;
            }, 2000);
        }
    }
}

///////////////////////////
// 7. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
///////////////////////////
async function initDashboard() {
    updateDateTime();
    setInterval(updateDateTime, 1000);

    try {
        await loadDataFromSheet();
        populateDashboard();
        createTrendChart();
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', e);
        document.getElementById('lastUpdate').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
    }
}

document.addEventListener('DOMContentLoaded', initDashboard);
</script>
</body>
</html>
