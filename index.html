<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞—à–±–æ—Ä–¥ | –û–û–û "–¢–ö –í–ï–õ–ï–°"</title>
    <style>
        :root {
  /* Primitive Color Tokens */
  --color-white: rgba(255, 255, 255, 1);
  --color-black: rgba(0, 0, 0, 1);
  --color-cream-50: rgba(252, 252, 249, 1);
  --color-cream-100: rgba(255, 255, 253, 1);
  --color-gray-200: rgba(245, 245, 245, 1);
  --color-gray-300: rgba(167, 169, 169, 1);
  --color-gray-400: rgba(119, 124, 124, 1);
  --color-slate-500: rgba(98, 108, 113, 1);
  --color-brown-600: rgba(94, 82, 64, 1);
  --color-charcoal-700: rgba(31, 33, 33, 1);
  --color-charcoal-800: rgba(38, 40, 40, 1);
  --color-slate-900: rgba(19, 52, 59, 1);
  --color-teal-300: rgba(50, 184, 198, 1);
  --color-teal-400: rgba(45, 166, 178, 1);
  --color-teal-500: rgba(33, 128, 141, 1);
  --color-teal-600: rgba(29, 116, 128, 1);
  --color-teal-700: rgba(26, 104, 115, 1);
  --color-teal-800: rgba(41, 150, 161, 1);
  --color-red-400: rgba(255, 84, 89, 1);
  --color-red-500: rgba(192, 21, 47, 1);
  --color-orange-400: rgba(230, 129, 97, 1);
  --color-orange-500: rgba(168, 75, 47, 1);

  /* Custom dashboard colors */
  --navy-primary: #1a2a4a;
  --navy-dark: #0f1a2e;
  --gold-accent: #d4a574;
  --gray-secondary: #4a5568;
  --success-green: #20b2aa;
  --warning-orange: #e8622b;
  --bg-light: #f7f8fa;
  --bg-card: #ffffff;
  --text-primary: #1a2a4a;
  --text-secondary: #6b7280;
  --border-color: #e5e7eb;

  /* RGB versions for opacity control */
  --color-brown-600-rgb: 94, 82, 64;
  --color-teal-500-rgb: 33, 128, 141;
  --color-slate-900-rgb: 19, 52, 59;
  --color-slate-500-rgb: 98, 108, 113;
  --color-red-500-rgb: 192, 21, 47;
  --color-red-400-rgb: 255, 84, 89;
  --color-orange-500-rgb: 168, 75, 47;
  --color-orange-400-rgb: 230, 129, 97;

  /* Background color tokens (Light Mode) */
  --color-bg-1: rgba(59, 130, 246, 0.08);
  --color-bg-2: rgba(245, 158, 11, 0.08);
  --color-bg-3: rgba(34, 197, 94, 0.08);
  --color-bg-4: rgba(239, 68, 68, 0.08);
  --color-bg-5: rgba(147, 51, 234, 0.08);
  --color-bg-6: rgba(249, 115, 22, 0.08);
  --color-bg-7: rgba(236, 72, 153, 0.08);
  --color-bg-8: rgba(6, 182, 212, 0.08);

  /* Semantic Color Tokens (Light Mode) */
  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-primary-active: var(--color-teal-700);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
  --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
  --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --color-btn-primary-text: var(--color-cream-50);
  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
  --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
  --color-error: var(--color-red-500);
  --color-success: var(--color-teal-500);
  --color-warning: var(--color-orange-500);
  --color-info: var(--color-slate-500);
  --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
  --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

  /* Common style patterns */
  --focus-ring: 0 0 0 3px var(--color-focus-ring);
  --focus-outline: 2px solid var(--color-primary);
  --status-bg-opacity: 0.15;
  --status-border-opacity: 0.25;

  /* Typography */
  --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system,
    BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo,
    Monaco, Consolas, monospace;
  --font-size-xs: 11px;
  --font-size-sm: 12px;
  --font-size-base: 14px;
  --font-size-md: 14px;
  --font-size-lg: 16px;
  --font-size-xl: 18px;
  --font-size-2xl: 20px;
  --font-size-3xl: 24px;
  --font-size-4xl: 30px;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 550;
  --font-weight-bold: 600;
  --line-height-tight: 1.2;
  --line-height-normal: 1.5;
  --letter-spacing-tight: -0.01em;

  /* Spacing */
  --space-0: 0;
  --space-1: 1px;
  --space-2: 2px;
  --space-4: 4px;
  --space-6: 6px;
  --space-8: 8px;
  --space-10: 10px;
  --space-12: 12px;
  --space-16: 16px;
  --space-20: 20px;
  --space-24: 24px;
  --space-32: 32px;

  /* Border Radius */
  --radius-sm: 6px;
  --radius-base: 8px;
  --radius-md: 10px;
  --radius-lg: 12px;
  --radius-full: 9999px;

  /* Shadows */
  --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04),
    0 2px 4px -1px rgba(0, 0, 0, 0.02);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04),
    0 4px 6px -2px rgba(0, 0, 0, 0.02);
  --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15),
    inset 0 -1px 0 rgba(0, 0, 0, 0.03);

  /* Animation */
  --duration-fast: 150ms;
  --duration-normal: 250ms;
  --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

  /* Layout */
  --container-sm: 640px;
  --container-md: 768px;
  --container-lg: 1024px;
  --container-xl: 1280px;
}

@font-face {
  font-family: 'FKGroteskNeue';
  src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2')
    format('woff2');
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: var(--font-family-base);
    background: var(--bg-light);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
}

.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: var(--space-24);
}

/* Header */
.dashboard-header {
    background: var(--navy-primary);
    color: white;
    padding: var(--space-24) var(--space-32);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-32);
    box-shadow: 0 4px 12px rgba(26, 42, 74, 0.15);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--space-16);
}

.company-info h1 {
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    margin-bottom: var(--space-4);
    letter-spacing: var(--letter-spacing-tight);
}

.company-info .subtitle {
    font-size: var(--font-size-base);
    opacity: 0.85;
    font-weight: var(--font-weight-normal);
}

.header-right {
    text-align: right;
}

.current-datetime {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-semibold);
    margin-bottom: var(--space-4);
}

.last-update {
    font-size: var(--font-size-sm);
    opacity: 0.75;
    display: flex;
    align-items: center;
    gap: var(--space-8);
    justify-content: flex-end;
}
        
.data-updated {
    font-size: var(--font-size-xs);
    opacity: 0.7;
    display: flex;
    align-items: center;
    gap: var(--space-8);
    justify-content: flex-end;
    margin-top: 4px;
}

.refresh-btn {
    background: var(--gold-accent);
    color: var(--navy-primary);
    border: none;
    padding: var(--space-8) var(--space-20);
    border-radius: var(--radius-base);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    cursor: pointer;
    transition: all var(--duration-normal) var(--ease-standard);
    margin-top: var(--space-8);
}

.refresh-btn:hover {
    background: #c89860;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(212, 165, 116, 0.3);
}
.repairs-totals-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px 16px;
}
.repairs-totals-grid .metric-row {
  display: flex; justify-content: space-between;
}

/* Metrics Grid */
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: var(--space-24);
    margin-bottom: var(--space-32);
}

.metric-card {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: var(--space-24);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    border: 1px solid var(--border-color);
    transition: all var(--duration-normal) var(--ease-standard);
}

.metric-card:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    transform: translateY(-2px);
}

.card-header {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: var(--space-20);
    padding-bottom: var(--space-16);
    border-bottom: 2px solid var(--border-color);
}
.card-header-text {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.card-header-text .metric-label {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
}
.card-icon {
    font-size: 32px;
}

.card-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    color: var(--navy-primary);
    letter-spacing: 0.5px;
}

.card-body {
    margin-bottom: var(--space-16);
}

.main-metric {
    font-size: 42px;
    font-weight: var(--font-weight-bold);
    color: var(--navy-primary);
    margin-bottom: var(--space-8);
    line-height: 1;
}

.metric-label {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    font-weight: var(--font-weight-medium);
    margin-bottom: var(--space-16);
}

.progress-section {
    margin: var(--space-16) 0;
}

.progress-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-8);
}

.progress-label {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--text-primary);
}

.progress-value {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    color: var(--success-green);
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: var(--border-color);
    border-radius: var(--radius-full);
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--success-green), var(--gold-accent));
    border-radius: var(--radius-full);
    transition: width 0.6s var(--ease-standard);
}

.secondary-metrics {
    display: flex;
    flex-direction: column;
    gap: var(--space-12);
    margin-top: var(--space-16);
    padding-top: var(--space-16);
    border-top: 1px solid var(--border-color);
}
/* –û–±—â–∏–µ —Å—Ç—Ä–æ–∫–∏ –º–µ—Ç—Ä–∏–∫ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö */
.metric-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-8);
}

.metric-value {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    color: var(--text-primary);
}

/* –ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç (–ø—Ä–æ—Ü–µ–Ω—Ç—ã, –ø—Ä–æ—Å—Ä–æ—á–∫–∞) */
.text-accent {
    color: var(--warning-orange);
}

/* –¢–∞–±–ª–∏—Ü—ã –≤ –ø–∞–Ω–µ–ª—è—Ö (–∫–ª–∏–µ–Ω—Ç—ã, –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è) */
.metric-table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--font-size-xs);
}

.metric-table th,
.metric-table td {
    padding: 4px 6px;
}

.metric-table th {
    text-align: left;
    font-weight: var(--font-weight-semibold);
    color: var(--text-secondary);
    border-bottom: 1px solid rgba(148, 163, 184, 0.3);
}

.metric-table td.amount,
.metric-table td.percent {
    text-align: right;
    white-space: nowrap;
}

.metric-table td.percent {
    color: var(--warning-orange);
}

.metric-table tr:nth-child(even) {
    background-color: rgba(15, 23, 42, 0.02);
}

/* –ö–Ω–æ–ø–∫–∏-—Å—Å—ã–ª–∫–∏ –ø–æ–¥ –∫–∞—Ä—Ç–æ—á–∫–æ–π */
.link-button {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.link-button:hover {
    color: var(--navy-primary);
}

/* –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã */
.mt-1 { margin-top: 4px; }
.mt-2 { margin-top: 8px; }
.mt-3 { margin-top: 12px; }
.mt-4 { margin-top: 24px; }  /* –º–æ–∂–Ω–æ 20‚Äì24px, –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Å—è –ø–æ –≥–ª–∞–∑—É */

/* –°–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–µ–π (overdue / payments) */
.hidden {
    display: none;
}

.secondary-metric {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: var(--font-size-sm);
}
.secondary-metric.month-plan .secondary-metric-label,
.secondary-metric.month-plan .secondary-metric-value {
    font-size: var(--font-size-md);       /* —á—É—Ç—å –∫—Ä—É–ø–Ω–µ–µ */
    font-weight: var(--font-weight-bold); /* –∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç */
}
.secondary-metric-label {
    color: var(--text-secondary);
    font-weight: var(--font-weight-medium);
}

.secondary-metric-value {
    font-weight: var(--font-weight-semibold);
    color: var(--text-primary);
}

/* Debt card specific */
.debt-amount {
    display: flex;
    flex-direction: column;
    gap: var(--space-12);
}

.debt-item {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
}

.debt-label {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    font-weight: var(--font-weight-medium);
}

.debt-value {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
}

.debt-value.total {
    color: var(--navy-primary);
}

.debt-value.overdue {
    color: var(--warning-orange);
}

.progress-fill.warning {
    background: linear-gradient(90deg, var(--warning-orange), #ff9a62);
}
/* Receivables by client (drilldown) */
.clients-overdue-toggle {
    margin-top: var(--space-12);
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.clients-overdue-toggle:hover {
    color: var(--navy-primary);
}

.clients-overdue-panel {
    margin-top: var(--space-12);
    padding-top: var(--space-8);
    border-top: 1px dashed rgba(148, 163, 184, 0.6);
}

.clients-overdue-panel.hidden {
    display: none;
}

.clients-table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--font-size-xs);
}

.clients-table th,
.clients-table td {
    padding: 4px 6px;
}

.clients-table th {
    text-align: left;
    font-weight: var(--font-weight-semibold);
    color: var(--text-secondary);
    border-bottom: 1px solid rgba(148, 163, 184, 0.3);
}

.clients-table td.amount,
.clients-table td.percent {
    text-align: right;
    white-space: nowrap;
}

.clients-table td.percent {
    color: var(--warning-orange);
}

.clients-table tr:nth-child(even) {
    background-color: rgba(15, 23, 42, 0.02);
}

/* Repairs card specific */
.repair-breakdown {
    display: flex;
    flex-direction: column;
    gap: var(--space-16);
}

.repair-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-12);
    background: var(--bg-light);
    border-radius: var(--radius-base);
    border-left: 4px solid var(--navy-primary);
}

.repair-item:nth-child(1) {
    border-left-color: var(--success-green);
}

.repair-item:nth-child(2) {
    border-left-color: var(--warning-orange);
}

.repair-item:nth-child(3) {
    border-left-color: var(--gold-accent);
}

.repair-info {
    display: flex;
    flex-direction: column;
}

.repair-type {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-bold);
    color: var(--navy-primary);
}

.repair-description {
    font-size: 11px;
    color: var(--text-secondary);
}

.repair-stats {
    text-align: right;
}

.repair-count {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--navy-primary);
}

.repair-percent {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
}

/* Chart Section */
.chart-section {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: var(--space-24);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    border: 1px solid var(--border-color);
}

.chart-header {
    margin-bottom: var(--space-24);
    padding-bottom: var(--space-16);
    border-bottom: 2px solid var(--border-color);
}

.chart-title {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--navy-primary);
}

.chart-container {
    height: 300px;
    position: relative;
}

/* Responsive */
@media (max-width: 768px) {
    .dashboard-container {
        padding: var(--space-16);
    }

    .header-content {
        flex-direction: column;
        align-items: flex-start;
    }

    .header-right {
        text-align: left;
        width: 100%;
    }

    .last-update {
        justify-content: flex-start;
    }

    .metrics-grid {
        grid-template-columns: 1fr;
    }

    .main-metric {
        font-size: 36px;
    }

    .company-info h1 {
        font-size: var(--font-size-2xl);
    }
}

@media (max-width: 480px) {
    .dashboard-header {
        padding: var(--space-16);
    }

    .metric-card {
        padding: var(--space-16);
    }

    .main-metric {
        font-size: 32px;
    }
}
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <div class="company-info">
                    <h1>–û–û–û "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –ö–æ–º–ø–∞–Ω–∏—è '–í–ï–õ–ï–°'"</h1>
                    <p class="subtitle">–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –¥–∞—à–±–æ—Ä–¥</p>
                </div>
                <div class="header-right">
                    <div class="current-datetime" id="currentDateTime">‚Äî</div>
                    <div class="last-update">
                        <span>‚è±</span>
                        <span id="lastUpdate">–ü–æ–≥—Ä—É–∑–∫–∞ —Å ‚Äî –ø–æ ‚Äî</span>
                    </div>
                    <div class="data-updated">
                        <span>üïí</span>
                        <span id="dataUpdatedAt">–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ‚Äî</span>
                    </div>
                    <button class="refresh-btn" onclick="refreshData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                </div>

            </div>
        </header>

        <!-- Metrics Grid -->
        <div class="metrics-grid">
            <!-- Card 1: Loading -->
            <div class="metric-card">
                <div class="card-header">
                    <div class="card-icon">üì¶</div>
                    <h2 class="card-title">–ü–û–ì–†–£–ó–ö–ê</h2>
                </div>
                <div class="card-body">
                    <div class="main-metric" id="loadedWagonsMonth">‚Äî</div>
                    <div class="metric-label">–ü–æ–≥—Ä—É–∂–µ–Ω–æ –≤–∞–≥–æ–Ω–æ–≤ (–º–µ—Å—è—Ü)</div>
                    
                    <div class="progress-section">
                        <div class="progress-info">
                            <span class="progress-label">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞</span>
                            <span class="progress-value" id="progressPercent">‚Äî</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="secondary-metrics">
                        <div class="secondary-metric">
                            <span class="secondary-metric-label">–ü–æ –ø–ª–∞–Ω—É:</span>
                            <span class="secondary-metric-value" id="planMonth">‚Äî</span>
                        </div>
                        <div class="secondary-metric">
                            <span class="secondary-metric-label">–í—á–µ—Ä–∞ –ø–æ–≥—Ä—É–∂–µ–Ω–æ:</span>
                            <span class="secondary-metric-value" id="loadedYesterday">‚Äî</span>
                        </div>
                       <div class="secondary-metric month-plan">
                            <span class="secondary-metric-label">–ü–ª–∞–Ω –Ω–∞ –º–µ—Å—è—Ü:</span>
                            <span class="secondary-metric-value" id="fullMonthPlan">‚Äî</span>
                        </div>
                    </div>
                </div>
            </div>
<!-- Card: Receivables (–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å + –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è) -->
            <div class="metric-card">
              <div class="card-header">
                <div class="card-icon">üí≥</div>
                <div class="card-header-text">
                  <h2 class="card-title">–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨</h2>
                  <div id="receivablesDate" class="metric-label"></div>
                </div>
              </div>
            
              <div class="card-body">
                <!-- –û–±—â–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å -->
                <div class="metric-row">
                  <span class="metric-label">–û–±—â–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å:</span>
                  <span id="totalDebt" class="metric-value">0 –º–ª–Ω. —Ä.</span>
                </div>
            
                <!-- –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è -->
                <div class="metric-row">
                  <span class="metric-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è:</span>
                  <span id="overdueDebt" class="metric-value text-accent">0 –º–ª–Ω. —Ä.</span>
                </div>
            
                <!-- –î–æ–ª—è –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–π -->
                <div class="metric-row">
                  <span class="metric-label">–î–æ–ª—è –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–π</span>
                  <span id="overduePercent" class="metric-value text-accent">0%</span>
                </div>
            
                <div class="progress-bar">
                  <div id="overdueProgressFill" class="progress-fill"></div>
                </div>
            
                <!-- –ö–Ω–æ–ø–∫–∞: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º -->
                <div class="metric-row mt-2">
                  <button id="toggleClientsOverdue" class="link-button">
                    ‚ñº –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º
                  </button>
                </div>
            
                <!-- –ü–∞–Ω–µ–ª—å: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–π –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º -->
                <div id="clientsOverduePanel" class="hidden">
                  <table class="metric-table">
                    <thead>
                      <tr>
                        <th>–ö–ª–∏–µ–Ω—Ç</th>
                        <th>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è</th>
                        <th>%</th>
                      </tr>
                    </thead>
                    <tbody id="clientsOverdueBody"></tbody>
                  </table>
                </div>
            
                <!-- –ë–ª–æ–∫ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π: –æ–ø—É—Å–∫–∞–µ–º –Ω–∏–∂–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã -->
                <div class="metric-row mt-4">
                  <span class="metric-label">–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è:</span>
                  <span id="paymentsTotal" class="metric-value">0 –º–ª–Ω. —Ä.</span>
                </div>
            
                <!-- –ö–Ω–æ–ø–∫–∞: –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º -->
                <div class="metric-row mt-1">
                  <button id="toggleClientsPayments" class="link-button">
                    ‚ñº –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º
                  </button>
                </div>
            
                <!-- –ü–∞–Ω–µ–ª—å: –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º -->
                <div id="clientsPaymentsPanel" class="hidden">
                  <table class="metric-table">
                    <thead>
                      <tr>
                        <th>–ö–ª–∏–µ–Ω—Ç</th>
                        <th>–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</th>
                        <th>%</th>
                      </tr>
                    </thead>
                    <tbody id="clientsPaymentsBody"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Card 3: Repairs -->
            <div class="metric-card">
                  <div class="card-header">
                    <div class="card-icon">üõ†Ô∏è</div>
                    <h2 class="card-title">–†–ï–ú–û–ù–¢–´</h2>
                    <div id="repairsDate" class="metric-label"></div>
                  </div>
                
                  <div class="card-body">
                    <div id="repairsTotalsList" class="repairs-totals-grid"></div>
                
                    <div class="metric-row mt-2">
                      <button id="toggleRepairsTable" class="link-button">‚ñº –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ —Ä–µ–º–æ–Ω—Ç–∞–º</button>
                    </div>
                
                    <div id="repairsTablePanel" class="hidden">
                      <table class="metric-table">
                        <thead>
                          <tr>
                            <th>–í–∏–¥ —Ä–µ–º–æ–Ω—Ç–∞</th>
                            <th>–í —Ä–µ–º–æ–Ω—Ç–µ</th>
                            <th>–í –ø—É—Ç–∏</th>
                            <th>–í –æ–∂–∏–¥–∞–Ω–∏–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</th>
                            <th>–í –æ–∂–∏–¥–∞–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏</th>
                            <th>–ò—Ç–æ–≥–æ</th>
                          </tr>
                        </thead>
                        <tbody id="repairsTableBody"></tbody>
                      </table>
                    </div>
                      <div class="metric-row mt-2">
                        <span class="metric-label">–í—Å–µ–≥–æ –≤–∞–≥–æ–Ω–æ–≤ –≤ –ø–∞—Ä–∫–µ:</span>
                        <span class="metric-value" id="fleetTotal">‚Äî</span>
                      </div>
                  </div>
                </div>
                </div>
            </div>
          </div>

        <!-- Chart Section -->
        <div class="chart-section">
            <div class="chart-header">
                <h3 class="chart-title">–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ–≥—Ä—É–∑–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</h3>
            </div>
            <div class="chart-container">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>


<script>
'use strict';

// ==========================
// 1. –°–°–´–õ–ö–ê –ù–ê GOOGLE SHEETS
// ==========================
// –í–°–¢–ê–í–¨ —Å—é–¥–∞ —Å–≤–æ—é CSV-—Å—Å—ã–ª–∫—É —Å output=csv
const SHEET_CSV_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRy08FvutySDN...dgBnpFX-t5uwX6JUcmg4/pub?gid=1433292947&single=true&output=csv';
// ar_agg_client_contract (–ù–û–í–ê–Ø —Å—Å—ã–ª–∫–∞, —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ—Å—Ä–æ—á–∫–∏)
const SHEET_CLIENTS_CSV_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRy08FvutySDN...2GdgBnpFX-t5uwX6JUcmg4/pub?gid=57311955&single=true&output=csv';
const SHEET_PAYMENTS_CSV_URL = 'https://docs.google.com/spreadsh...GdgBnpFX-t5uwX6JUcmg4/pub?gid=740110225&single=true&output=csv';
const SHEET_REPAIRS_CSV_URL = 'https://docs.google.com/spreadshe...dgBnpFX-t5uwX6JUcmg4/pub?gid=1619190380&single=true&output=csv';

let dashboardData = null;
let trendChart = null;
let receivablesByClient = [];   // —Å—é–¥–∞ –ø–æ–ª–æ–∂–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ—Å—Ä–æ—á–∫–∏ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º
let paymentsLastDays = [];      // —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ –æ–ø–ª–∞—Ç–∞–º –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–Ω–∏ (–¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–∞ –ø–ª–∞—Ç–µ–∂–µ–π)

// ==========================
// 2. –£–¢–ò–õ–ò–¢–´
// ==========================
function parseCSV(text) {
  const rows = [];
  let current = '';
  let row = [];
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    if (c === '"') {
      if (inQuotes && text[i + 1] === '"') {
        current += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (c === ';' && !inQuotes) {
      row.push(current);
      current = '';
    } else if ((c === '\n' || c === '\r') && !inQuotes) {
      if (current !== '' || row.length) {
        row.push(current);
        rows.push(row);
        row = [];
        current = '';
      }
    } else {
      current += c;
    }
  }
  if (current !== '' || row.length) {
    row.push(current);
    rows.push(row);
  }
  return rows;
}

function toNumber(value) {
  if (value === null || value === undefined) return 0;
  if (typeof value === 'number') return value;
  let v = String(value).replace(/\s+/g, '').replace(',', '.');
  const n = parseFloat(v);
  return Number.isFinite(n) ? n : 0;
}

function formatNumber(num) {
  if (num === null || num === undefined || isNaN(num)) return '0';
  return Number(num).toLocaleString('ru-RU');
}

function formatPercent(value, digits = 1) {
  if (value === null || value === undefined || isNaN(value)) return '0%';
  return (value * 100).toFixed(digits).replace('.', ',') + '%';
}

function parseDate(str) {
  if (!str) return null;
  // –æ–∂–∏–¥–∞–µ–º —Ñ–æ—Ä–º–∞—Ç —Ç–∏–ø–∞ 2025-11-18 –∏–ª–∏ 18.11.2025
  if (/^\d{4}-\d{2}-\d{2}$/.test(str)) {
    return new Date(str + 'T00:00:00');
  }
  const m = str.match(/^(\d{1,2})\.(\d{1,2})\.(\d{2,4})$/);
  if (m) {
    const d = m[1].padStart(2, '0');
    const mm = m[2].padStart(2, '0');
    let yy = m[3];
    if (yy.length === 2) yy = '20' + yy;
    return new Date(`${yy}-${mm}-${d}T00:00:00`);
  }
  const ts = Date.parse(str);
  return Number.isNaN(ts) ? null : new Date(ts);
}

function formatDateRuShort(dateStr) {
  const d = parseDate(dateStr);
  if (!d) return dateStr || '';
  return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function formatUpdatedAt(date) {
  return date.toLocaleString('ru-RU', {
    day: '2-digit',
    month: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
  });
}

// ==========================
// 3. –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
// ==========================
async function fetchCSV(url) {
  const resp = await fetch(url + '&_ts=' + Date.now());
  if (!resp.ok) {
    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSV ' + resp.status);
  }
  const text = await resp.text();
  return parseCSV(text);
}

async function loadDataFromSheet() {
  const [rawRows, clientRows, paymentRows, repairRows] = await Promise.all([
    fetchCSV(SHEET_CSV_URL),
    fetchCSV(SHEET_CLIENTS_CSV_URL),
    fetchCSV(SHEET_PAYMENTS_CSV_URL),
    fetchCSV(SHEET_REPAIRS_CSV_URL),
  ]);

  const parsedMain = buildDashboardData(rawRows);
  receivablesByClient = buildReceivablesByClient(clientRows);
  const paymentsStruct = buildPaymentsDaily(paymentRows);
  paymentsLastDays = paymentsStruct.items || [];

  const repairsItems = buildRepairsFromSnapshot(repairRows);
  dashboardData = {
    ...parsedMain,
    repairs: {
      snapshotDate: paymentsStruct.lastDate,
      items: repairsItems,
      fleet_total: parsedMain.repairs.fleet_total,
    },
  };
}

// ==========================
// 4. –ü–ê–†–°–ò–ù–ì –û–°–ù–û–í–ù–û–ì–û CSV
// ==========================
function buildDashboardData(rows) {
  if (!rows || rows.length < 2) {
    console.warn('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö raw_data');
    return {
      date: null,
      total_wagons: 0,
      loaded_today: 0,
      loaded_yesterday: 0,
      loaded_plan: 0,
      loaded_diff: 0,
      loaded_diff_pct: 0,
      utilization: 0,
      idle_total: 0,
      idle_over_5: 0,
      idle_over_10: 0,
      idle_over_5_pct: 0,
      idle_over_10_pct: 0,
      clients_overdue: [],
      daily_trend: [],
      repairs: {
        fleet_total: 0,
      },
    };
  }

  const header = rows[0].map(h => h.toLowerCase().trim());

  const idxDate = header.indexOf('date');
  const idxTotalWagons = header.indexOf('total_wagons');
  const idxLoadedToday = header.indexOf('loaded_today');
  const idxLoadedYesterday = header.indexOf('loaded_yesterday');
  const idxLoadedPlan = header.indexOf('loaded_plan');
  const idxUtilization = header.indexOf('utilization');

  const idxIdleTotal = header.indexOf('idle_total');
  const idxIdleOver5 = header.indexOf('idle_over_5');
  const idxIdleOver10 = header.indexOf('idle_over_10');

  const idxFleetTotal = header.indexOf('fleet_total');

  let lastRow = rows[rows.length - 1];
  for (let i = rows.length - 1; i >= 1; i--) {
    const r = rows[i];
    if (r && r.some(v => v !== '')) {
      lastRow = r;
      break;
    }
  }

  const dateStr = idxDate !== -1 ? lastRow[idxDate] : null;
  const totalWagons = toNumber(idxTotalWagons !== -1 ? lastRow[idxTotalWagons] : 0);
  const loadedToday = toNumber(idxLoadedToday !== -1 ? lastRow[idxLoadedToday] : 0);
  const loadedYesterday = toNumber(idxLoadedYesterday !== -1 ? lastRow[idxLoadedYesterday] : 0);
  const loadedPlan = toNumber(idxLoadedPlan !== -1 ? lastRow[idxLoadedPlan] : 0);
  const utilization = toNumber(idxUtilization !== -1 ? lastRow[idxUtilization] : 0);

  const idleTotal = toNumber(idxIdleTotal !== -1 ? lastRow[idxIdleTotal] : 0);
  const idleOver5 = toNumber(idxIdleOver5 !== -1 ? lastRow[idxIdleOver5] : 0);
  const idleOver10 = toNumber(idxIdleOver10 !== -1 ? lastRow[idxIdleOver10] : 0);

  const fleetTotal = toNumber(idxFleetTotal !== -1 ? lastRow[idxFleetTotal] : 0);

  const loadedDiff = loadedToday - loadedYesterday;
  const loadedDiffPct = loadedYesterday ? (loadedDiff / loadedYesterday) : 0;

  const idleOver5Pct = idleTotal ? (idleOver5 / idleTotal) : 0;
  const idleOver10Pct = idleTotal ? (idleOver10 / idleTotal) : 0;

  const dailyTrend = buildDailyTrend(rows, header);

  return {
    date: dateStr,
    total_wagons: totalWagons,
    loaded_today: loadedToday,
    loaded_yesterday: loadedYesterday,
    loaded_plan: loadedPlan,
    loaded_diff: loadedDiff,
    loaded_diff_pct: loadedDiffPct,
    utilization: utilization,
    idle_total: idleTotal,
    idle_over_5: idleOver5,
    idle_over_10: idleOver10,
    idle_over_5_pct: idleOver5Pct,
    idle_over_10_pct: idleOver10Pct,
    daily_trend: dailyTrend,
    repairs: {
      fleet_total: fleetTotal,
    },
  };
}

function buildDailyTrend(rows, header) {
  const idxDate = header.indexOf('date');
  const idxLoaded = header.indexOf('loaded_today');
  if (idxDate === -1 || idxLoaded === -1) return [];

  const result = [];
  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];
    if (!r || !r[idxDate]) continue;
    const d = parseDate(r[idxDate]);
    if (!d) continue;
    const wagons = toNumber(r[idxLoaded]);
    result.push({
      date: d,
      wagons,
      label: d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' }),
    });
  }

  result.sort((a, b) => a.date - b.date);
  return result.slice(-7);
}

// ==========================
// 5. –ü–†–û–°–†–û–ß–ö–ê –ü–û –ö–õ–ò–ï–ù–¢–ê–ú
// ==========================
function buildReceivablesByClient(rows) {
  if (!rows || rows.length < 2) return [];
  const header = rows[0].map(h => h.toLowerCase().trim());

  const idxClient = header.indexOf('client_name');
  const idxOverdue = header.indexOf('overdue_total');
  const idxBucket = header.indexOf('bucket_name');

  if (idxClient === -1 || idxOverdue === -1 || idxBucket === -1) {
    console.warn('–ù–µ—Ç –Ω—É–∂–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ –≤ ar_agg_client_contract');
    return [];
  }

  const map = new Map();

  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];
    if (!r || !r[idxClient]) continue;
    const client = r[idxClient];
    const overdue = toNumber(r[idxOverdue]);
    const bucket = r[idxBucket];
    if (!map.has(client)) {
      map.set(client, { client, total_overdue: 0, buckets: {} });
    }
    const obj = map.get(client);
    obj.total_overdue += overdue;
    obj.buckets[bucket] = (obj.buckets[bucket] || 0) + overdue;
  }

  const arr = Array.from(map.values());
  arr.sort((a, b) => b.total_overdue - a.total_overdue);
  return arr;
}

// ==========================
// 6. –ü–õ–ê–¢–ï–ñ–ò –ü–û –î–ù–Ø–ú
// ==========================
function buildPaymentsDaily(rows) {
  if (!rows || rows.length < 2) {
    console.warn('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ –æ–ø–ª–∞—Ç');
    return { lastDate: null, items: [] };
  }
  const header = rows[0].map(h => h.toLowerCase().trim());

  const idxAsOf = header.indexOf('as_of_date');
  const idxClient = header.indexOf('client_name');
  const idxTotal  = header.indexOf('total_received');

  if (idxAsOf === -1 || idxClient === -1 || idxTotal === -1) {
    console.warn('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω—É–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ ar_payments_daily');
    return { lastDate: null, items: [] };
  }

  let maxDate = null;
  const byDate = {};

  for (let i = 1; i < rows.length; i++) {
    const row = rows[i];
    if (!row || !row.length) continue;

    const dStr = row[idxAsOf];
    const d = parseDate(dStr);
    if (!d) continue;

    const client = row[idxClient];
    const amt = toNumber(row[idxTotal]);

    const key = d.toISOString().slice(0, 10);
    if (!byDate[key]) {
      byDate[key] = { date: d, total: 0, perClient: {} };
    }
    byDate[key].total += amt;
    byDate[key].perClient[client] = (byDate[key].perClient[client] || 0) + amt;

    if (!maxDate || d > maxDate) maxDate = d;
  }

  const items = Object.values(byDate).sort((a, b) => a.date - b.date);
  const lastDateKey = maxDate ? maxDate.toISOString().slice(0, 10) : null;

  return {
    lastDate: lastDateKey,
    items,
  };
}

// ==========================
// 7. –†–ï–ú–û–ù–¢–´ (SNAPSHOT)
// ==========================
function buildRepairsFromSnapshot(rows) {
  if (!rows || !rows.length) return [];

  // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º, –≥–¥–µ –µ—Å—Ç—å "–≤–∏–¥ —Ä–µ–º–æ–Ω—Ç–∞"
  let headerRowIndex = rows.findIndex(r =>
    r && r.some(cell => cell && cell.toString().toLowerCase().includes('–≤–∏–¥ —Ä–µ–º–æ–Ω—Ç–∞'))
  );
  if (headerRowIndex === -1) {
    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å—Ç—Ä–æ–∫—É –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≤ repairs_snapshot');
    return [];
  }

  const hdr = rows[headerRowIndex].map(h => (h || '').toString().toLowerCase().trim());
  const idx = {
    type: hdr.indexOf('–≤–∏–¥ —Ä–µ–º–æ–Ω—Ç–∞'),
    r: hdr.indexOf('–≤ —Ä–µ–º–æ–Ω—Ç–µ'),
    t: hdr.indexOf('–≤ –ø—É—Ç–∏'),
    reg: hdr.indexOf('–≤ –æ–∂–∏–¥–∞–Ω–∏–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –≤ —Ä–µ–º–æ–Ω—Ç'),
    disp: hdr.indexOf('–≤ –æ–∂–∏–¥–∞–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑ —Ä–µ–º–æ–Ω—Ç–∞'),
  };

  // —Å—Ç–æ–ª–±–µ—Ü —Å –∏—Ç–æ–≥–æ–º –º–æ–∂–µ—Ç –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è "–≤—Å–µ–≥–æ" –∏–ª–∏ "–∏—Ç–æ–≥–æ"
  let totalIdx = hdr.indexOf('–≤—Å–µ–≥–æ');
  if (totalIdx === -1) {
    totalIdx = hdr.indexOf('–∏—Ç–æ–≥–æ');
  }
  idx.total = totalIdx;

  if (idx.type === -1) {
    console.warn('–í repairs_snapshot –Ω–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ "–≤–∏–¥ —Ä–µ–º–æ–Ω—Ç–∞"');
    return [];
  }

  const items = [];
  for (let i = headerRowIndex + 1; i < rows.length; i++) {
    const r = rows[i];
    if (!r || !r.length) continue;
    const typeVal = r[idx.type];
    if (!typeVal) continue;

    const safeNum = (arr, idx) => {
      if (idx === -1) return 0;
      const v = arr[idx];
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    };

    items.push({
      type: String(typeVal).trim(),
      in_repair:     safeNum(r, idx.r),
      in_transit:    safeNum(r, idx.t),
      await_reg:     safeNum(r, idx.reg),
      await_dispatch:safeNum(r, idx.disp),
      total:         safeNum(r, idx.total),
    });
  }
  return items;
}

// ==========================
// 8. –û–¢–†–ò–°–û–í–ö–ê –î–ê–®–ë–û–†–î–ê
// ==========================
function populateDashboard() {
  if (!dashboardData) return;

  const d = dashboardData;

  const dateEl = document.getElementById('reportDate');
  if (dateEl) {
    dateEl.textContent = d.date ? formatDateRuShort(d.date) : '‚Äî';
  }

  const fleetTotalEl = document.getElementById('fleetTotal');
  if (fleetTotalEl) {
    fleetTotalEl.textContent = formatNumber(d.repairs.fleet_total || 0);
  }

  setText('loadedToday', formatNumber(d.loaded_today));
  setText('loadedYesterday', formatNumber(d.loaded_yesterday));
  setText('loadedPlan', formatNumber(d.loaded_plan));
  setText('loadedDiff', (d.loaded_diff >= 0 ? '+' : '') + formatNumber(d.loaded_diff));
  setText('loadedDiffPct', (d.loaded_diff >= 0 ? '+' : '') + formatPercent(d.loaded_diff_pct));

  setText('utilization', formatPercent(d.utilization));

  setText('idleTotal', formatNumber(d.idle_total));
  setText('idleOver5', formatNumber(d.idle_over_5));
  setText('idleOver10', formatNumber(d.idle_over_10));
  setText('idleOver5Pct', formatPercent(d.idle_over_5_pct));
  setText('idleOver10Pct', formatPercent(d.idle_over_10_pct));

  renderRepairsCard(d.repairs.items || [], d.date);
  renderReceivablesTable(receivablesByClient);
}

function setText(id, value) {
  const el = document.getElementById(id);
  if (el) el.textContent = value;
}

function renderReceivablesTable(clients) {
  const tbody = document.getElementById('clientsTableBody');
  if (!tbody) return;
  tbody.innerHTML = '';

  const top = (clients || []).slice(0, 15);

  top.forEach(c => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${c.client}</td>
      <td class="text-right">${formatNumber(c.total_overdue)}</td>
    `;
    tbody.appendChild(tr);
  });

  const totalOverdue = top.reduce((sum, c) => sum + (c.total_overdue || 0), 0);
  const totalEl = document.getElementById('totalOverdueTop');
  if (totalEl) {
    totalEl.textContent = formatNumber(totalOverdue);
  }
}

function renderRepairsCard(items, dateStr) {
  const order = ['TOR','DR','KR','DRA','WASH'];
  const labels = {
    TOR: '–¢–û–†',
    DR:  '–î–†',
    KR:  '–ö–†',
    DRA: '–î–†–ê',
    WASH:'–ü—Ä–æ–º—ã–≤–∫–∞'
  };

  const list = document.getElementById('repairsTotalsList');
  if (!list) return;
  list.innerHTML = '';

  const normalized = {};
  (items || []).forEach(x => {
    if (!x || !x.type) return;
    const key = String(x.type).toUpperCase().trim();
    normalized[key] = x;
  });

  // –¢–æ—Ç–∞–ª—ã –ø–æ –≤–∏–¥–∞–º
  order.forEach(code => {
    const x = normalized[code] || { total: 0 };
    const row = document.createElement('div');
    row.className = 'metric-row';
    row.innerHTML = `
      <span class="metric-label">${labels[code] || code}</span>
      <span class="metric-value">${formatNumber(x.total || 0)}</span>
    `;
    list.appendChild(row);
  });

  // –¢–∞–±–ª–∏—Ü–∞ –ø–æ —Å—Ç–∞–¥–∏—è–º
  const tbody = document.getElementById('repairsTableBody');
  if (tbody) {
    tbody.innerHTML = '';
    order.forEach(code => {
      const x = normalized[code] || {
        in_repair: 0,
        in_transit: 0,
        await_reg: 0,
        await_dispatch: 0,
        total: 0,
      };
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${labels[code] || code}</td>
        <td>${x.in_repair || 0}</td>
        <td>${x.in_transit || 0}</td>
        <td>${x.await_reg || 0}</td>
        <td>${x.await_dispatch || 0}</td>
        <td><b>${x.total || 0}</b></td>
      `;
      tbody.appendChild(tr);
    });
  }

  const dateEl = document.getElementById('repairsDate');
  if (dateEl) {
    dateEl.textContent = dateStr ? ('–î–∞–Ω–Ω—ã–µ –Ω–∞ ' + formatDateRuShort(dateStr)) : '';
  }

  const btn = document.getElementById('toggleRepairsTable');
  if (btn) {
    btn.onclick = () => {
      const panel = document.getElementById('repairsTablePanel');
      if (panel) panel.classList.toggle('hidden');
    };
  }
}

// ==========================
// 9. –û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–•
// ==========================
async function refreshData() {
  const btn = document.querySelector('.refresh-btn');
  if (btn) btn.disabled = true;

  try {
    await loadDataFromSheet();
    populateDashboard();

    const updatedEl = document.getElementById('dataUpdatedAt');
    if (updatedEl) {
      const now = new Date();
      updatedEl.textContent = '–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ' + formatUpdatedAt(now);
    }

    const lastUpdEl = document.getElementById('lastUpdate');
    if (lastUpdEl && dashboardData && dashboardData.date) {
      lastUpdEl.textContent = '–°—Ä–µ–∑ –Ω–∞ ' + formatDateRuShort(dashboardData.date);
    }

    if (btn) {
      btn.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–æ ‚úî';
      setTimeout(() => {
        btn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
        btn.disabled = false;
      }, 1500);
    }
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', e);
    const updatedEl = document.getElementById('dataUpdatedAt');
    if (updatedEl) {
      updatedEl.textContent = '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö';
    }
    const lastUpdEl = document.getElementById('lastUpdate');
    if (lastUpdEl) {
      lastUpdEl.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
    }
    if (btn) {
      btn.textContent = '–û—à–∏–±–∫–∞ üòï';
      setTimeout(() => {
        btn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
        btn.disabled = false;
      }, 2000);
    }
  }
}

// ==========================
// 10. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// ==========================
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.querySelector('.refresh-btn');
  if (btn) {
    btn.addEventListener('click', () => {
      refreshData();
    });
  }
  refreshData();
});


</script>
</body>
</html>
