<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞—à–±–æ—Ä–¥ | –û–û–û "–¢–ö –í–ï–õ–ï–°"</title>
    <style>
        :root {
  /* Primitive Color Tokens */
  --color-white: rgba(255, 255, 255, 1);
  --color-black: rgba(0, 0, 0, 1);
  --color-cream-50: rgba(252, 252, 249, 1);
  --color-cream-100: rgba(255, 255, 253, 1);
  --color-gray-200: rgba(245, 245, 245, 1);
  --color-gray-300: rgba(167, 169, 169, 1);
  --color-gray-400: rgba(119, 124, 124, 1);
  --color-slate-500: rgba(98, 108, 113, 1);
  --color-brown-600: rgba(94, 82, 64, 1);
  --color-charcoal-700: rgba(31, 33, 33, 1);
  --color-charcoal-800: rgba(38, 40, 40, 1);
  --color-slate-900: rgba(19, 52, 59, 1);
  --color-teal-300: rgba(50, 184, 198, 1);
  --color-teal-400: rgba(45, 166, 178, 1);
  --color-teal-500: rgba(33, 128, 141, 1);
  --color-teal-600: rgba(29, 116, 128, 1);
  --color-teal-700: rgba(26, 104, 115, 1);
  --color-teal-800: rgba(41, 150, 161, 1);
  --color-red-400: rgba(255, 84, 89, 1);
  --color-red-500: rgba(192, 21, 47, 1);
  --color-orange-400: rgba(230, 129, 97, 1);
  --color-orange-500: rgba(168, 75, 47, 1);

  /* Custom dashboard colors */
  --navy-primary: #1a2a4a;
  --navy-dark: #0f1a2e;
  --gold-accent: #d4a574;
  --gray-secondary: #4a5568;
  --success-green: #20b2aa;
  --warning-orange: #e8622b;
  --bg-light: #f7f8fa;
  --bg-card: #ffffff;
  --text-primary: #1a2a4a;
  --text-secondary: #6b7280;
  --border-color: #e5e7eb;

  /* RGB versions for opacity control */
  --color-brown-600-rgb: 94, 82, 64;
  --color-teal-500-rgb: 33, 128, 141;
  --color-slate-900-rgb: 19, 52, 59;
  --color-slate-500-rgb: 98, 108, 113;
  --color-red-500-rgb: 192, 21, 47;
  --color-red-400-rgb: 255, 84, 89;
  --color-orange-500-rgb: 168, 75, 47;
  --color-orange-400-rgb: 230, 129, 97;

  /* Background color tokens (Light Mode) */
  --color-bg-1: rgba(59, 130, 246, 0.08);
  --color-bg-2: rgba(245, 158, 11, 0.08);
  --color-bg-3: rgba(34, 197, 94, 0.08);
  --color-bg-4: rgba(239, 68, 68, 0.08);
  --color-bg-5: rgba(147, 51, 234, 0.08);
  --color-bg-6: rgba(249, 115, 22, 0.08);
  --color-bg-7: rgba(236, 72, 153, 0.08);
  --color-bg-8: rgba(6, 182, 212, 0.08);

  /* Semantic Color Tokens (Light Mode) */
  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-primary-active: var(--color-teal-700);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
  --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
  --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --color-btn-primary-text: var(--color-cream-50);
  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
  --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
  --color-error: var(--color-red-500);
  --color-success: var(--color-teal-500);
  --color-warning: var(--color-orange-500);
  --color-info: var(--color-slate-500);
  --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
  --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

  /* Common style patterns */
  --focus-ring: 0 0 0 3px var(--color-focus-ring);
  --focus-outline: 2px solid var(--color-primary);
  --status-bg-opacity: 0.15;
  --status-border-opacity: 0.25;

  /* Typography */
  --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system,
    BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo,
    Monaco, Consolas, monospace;
  --font-size-xs: 11px;
  --font-size-sm: 12px;
  --font-size-base: 14px;
  --font-size-md: 14px;
  --font-size-lg: 16px;
  --font-size-xl: 18px;
  --font-size-2xl: 20px;
  --font-size-3xl: 24px;
  --font-size-4xl: 30px;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 550;
  --font-weight-bold: 600;
  --line-height-tight: 1.2;
  --line-height-normal: 1.5;
  --letter-spacing-tight: -0.01em;

  /* Spacing */
  --space-0: 0;
  --space-1: 1px;
  --space-2: 2px;
  --space-4: 4px;
  --space-6: 6px;
  --space-8: 8px;
  --space-10: 10px;
  --space-12: 12px;
  --space-16: 16px;
  --space-20: 20px;
  --space-24: 24px;
  --space-32: 32px;

  /* Border Radius */
  --radius-sm: 6px;
  --radius-base: 8px;
  --radius-md: 10px;
  --radius-lg: 12px;
  --radius-full: 9999px;

  /* Shadows */
  --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04),
    0 2px 4px -1px rgba(0, 0, 0, 0.02);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04),
    0 4px 6px -2px rgba(0, 0, 0, 0.02);
  --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15),
    inset 0 -1px 0 rgba(0, 0, 0, 0.03);

  /* Animation */
  --duration-fast: 150ms;
  --duration-normal: 250ms;
  --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

  /* Layout */
  --container-sm: 640px;
  --container-md: 768px;
  --container-lg: 1024px;
  --container-xl: 1280px;
}

@font-face {
  font-family: 'FKGroteskNeue';
  src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2')
    format('woff2');
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: var(--font-family-base);
    background: var(--bg-light);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
}

.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: var(--space-24);
}

/* Header */
.dashboard-header {
    background: var(--navy-primary);
    color: white;
    padding: var(--space-24) var(--space-32);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-32);
    box-shadow: 0 4px 12px rgba(26, 42, 74, 0.15);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--space-16);
}

.company-info h1 {
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    margin-bottom: var(--space-4);
    letter-spacing: var(--letter-spacing-tight);
}

.company-info .subtitle {
    font-size: var(--font-size-base);
    opacity: 0.85;
    font-weight: var(--font-weight-normal);
}

.header-right {
    text-align: right;
}

.current-datetime {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-semibold);
    margin-bottom: var(--space-4);
}
/* –ö—Ä—É–ø–Ω–µ–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è / –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è —Å–ª—É–∂–±–∞" */
#budget-card .budget-service-title {
    font-size: var(--font-size-base);        /* —á—É—Ç—å –±–æ–ª—å—à–µ, —á–µ–º —É "–†–∞—Å—Ö–æ–¥—ã" */
    font-weight: var(--font-weight-bold);
    color: var(--text-primary);
}

.last-update {
    font-size: var(--font-size-sm);
    opacity: 0.75;
    display: flex;
    align-items: center;
    gap: var(--space-8);
    justify-content: flex-start;
}
  .last-update-inline {
       margin-top: 2px;
  }
       
.data-updated {
    font-size: var(--font-size-xs);
    opacity: 0.7;
    display: flex;
    align-items: center;
    gap: var(--space-8);
    justify-content: flex-end;
    margin-top: 4px;
}

.refresh-btn {
    background: var(--gold-accent);
    color: var(--navy-primary);
    border: none;
    padding: var(--space-8) var(--space-20);
    border-radius: var(--radius-base);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    cursor: pointer;
    transition: all var(--duration-normal) var(--ease-standard);
    margin-top: var(--space-8);
}

.refresh-btn:hover {
    background: #c89860;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(212, 165, 116, 0.3);
}
.repairs-totals-grid {
  display: grid;
  grid-template-columns: repeat(5, minmax(0, 1fr));
  gap: 8px 16px;
  text-align: center;
}

.repair-total-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.repair-type-label {
  font-size: var(--font-size-xs);
  color: var(--text-secondary);
}

.repair-type-value {
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-bold);
  color: var(--text-primary);
}


/* Metrics Grid */
.metrics-grid {
    display: grid;
    /* –î–≤–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ä–∞–≤–Ω–æ–π —à–∏—Ä–∏–Ω—ã –Ω–∞ –≤—Å—é –¥–æ—Å—Ç—É–ø–Ω—É—é –æ–±–ª–∞—Å—Ç—å */
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: var(--space-24);
    margin-bottom: var(--space-32);
}

/* –ù–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö –∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö ‚Äî –ø–æ –æ–¥–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ –≤ —Ä—è–¥ */
@media (max-width: 1024px) {
    .metrics-grid {
        grid-template-columns: 1fr;
    }
}


/* –ë—é–¥–∂–µ—Ç: –Ω–∞ —à–∏—Ä–æ–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
@media (min-width: 1200px) {
    #budget-card {
        grid-column: 1 / -1;
    }
}


.metric-card {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: var(--space-24);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    border: 1px solid var(--border-color);
    transition: all var(--duration-normal) var(--ease-standard);
}

.metric-card:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    transform: translateY(-2px);
}

.card-header {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: var(--space-20);
    padding-bottom: var(--space-16);
    border-bottom: 2px solid var(--border-color);
}
.card-header-text {
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex: 1;
}
.card-header-text .metric-label {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
}
.card-icon {
    font-size: 32px;
}
.card-title-row {
  display: flex;
  align-items: flex-start;
  gap: 8px;
}

.card-title-suffix {
  margin-left: auto;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
}

.card-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    color: var(--navy-primary);
    letter-spacing: 0.5px;
}
.card-subtitle {
  font-size: calc(var(--font-size-base) * 1.1);  /* –≤ 2 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ, —á–µ–º –±—ã–ª–æ */
  font-weight: 600;
  color: var(--text-secondary);
  margin-top: 6px;
}

.card-body {
    margin-bottom: var(--space-16);
}

.main-metric {
    font-size: 42px;
    font-weight: var(--font-weight-bold);
    color: var(--navy-primary);
    margin-bottom: var(--space-8);
    line-height: 1;
}

.metric-label {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    font-weight: var(--font-weight-medium);
    margin-bottom: var(--space-16);
}

.progress-section {
    margin: var(--space-16) 0;
}

.progress-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-8);
}

.progress-label {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--text-primary);
}

.progress-value {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    color: var(--success-green);
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: var(--border-color);
    border-radius: var(--radius-full);
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--success-green), var(--gold-accent));
    border-radius: var(--radius-full);
    transition: width 0.6s var(--ease-standard);
}

.secondary-metrics {
    display: flex;
    flex-direction: column;
    gap: var(--space-12);
    margin-top: var(--space-16);
    padding-top: var(--space-16);
    border-top: 1px solid var(--border-color);
}
/* –û–±—â–∏–µ —Å—Ç—Ä–æ–∫–∏ –º–µ—Ç—Ä–∏–∫ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö */
.metric-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-8);
}
.subsection-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: var(--space-8);
}
.subsection-header .metric-label:first-child {
  font-weight: var(--font-weight-semibold);
  color: var(--text-primary);
}

.metric-value {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    color: var(--text-primary);
}

/* –ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç (–ø—Ä–æ—Ü–µ–Ω—Ç—ã, –ø—Ä–æ—Å—Ä–æ—á–∫–∞) */
.text-accent {
    color: var(--warning-orange);
}
/* –§–∞–∫—Ç –±–æ–ª—å—à–µ –ø–ª–∞–Ω–∞ */
.text-negative {
    color: var(--color-red-500);
}

/* –¢–∞–±–ª–∏—Ü—ã –≤ –ø–∞–Ω–µ–ª—è—Ö (–∫–ª–∏–µ–Ω—Ç—ã, –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è) */
.metric-table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--font-size-xs);
}

.metric-table th,
.metric-table td {
    padding: 4px 6px;
}

.metric-table th {
    text-align: left;
    font-weight: var(--font-weight-semibold);
    color: var(--text-secondary);
    border-bottom: 1px solid rgba(148, 163, 184, 0.3);
}

.metric-table td.amount,
.metric-table td.percent {
    text-align: right;
    white-space: nowrap;
}
/* –ß–∏—Å–ª–æ–≤—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ç–∞–∫ –∂–µ, –∫–∞–∫ —Ü–∏—Ñ—Ä—ã */
.metric-table th.amount {
    text-align: right;
}

.metric-table td.percent {
    color: var(--warning-orange);
}

.metric-table tr:nth-child(even) {
    background-color: rgba(15, 23, 42, 0.02);
}
/* –ë—é–¥–∂–µ—Ç: —Å–µ—Ç–∫–∞ –∏ —Å–ª—É–∂–µ–±–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ */
.budget-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 16px;
    margin-top: var(--space-12);
}
/* –ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö –±–ª–æ–∫–∏ –±—é–¥–∂–µ—Ç–∞ (–†–∞—Å—Ö–æ–¥—ã / –¢–∞—Ä–∏—Ñ) –≤—Å—Ç–∞—é—Ç –¥—Ä—É–≥ –ø–æ–¥ –¥—Ä—É–≥–æ–º */
@media (max-width: 768px) {
    .budget-grid {
        grid-template-columns: 1fr;
    }
}

.metric-table tr.group-row td {
    padding-top: 6px;
    font-weight: var(--font-weight-semibold);
    color: var(--text-secondary);
}

.metric-table tr.total-row td {
    border-top: 1px solid rgba(148, 163, 184, 0.6);
    font-weight: var(--font-weight-bold);
}

/* –ö–Ω–æ–ø–∫–∏-—Å—Å—ã–ª–∫–∏ –ø–æ–¥ –∫–∞—Ä—Ç–æ—á–∫–æ–π */
.link-button {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.link-button:hover {
    color: var(--navy-primary);
}

/* –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã */
.mt-1 { margin-top: 4px; }
.mt-2 { margin-top: 8px; }
.mt-3 { margin-top: 12px; }
.mt-4 { margin-top: 24px; }  /* –º–æ–∂–Ω–æ 20‚Äì24px, –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Å—è –ø–æ –≥–ª–∞–∑—É */

/* –°–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–µ–π (overdue / payments) */
.hidden {
    display: none;
}

.secondary-metric {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: var(--font-size-sm);
    margin-bottom: var(--space-12); /* –¥–æ–±–∞–≤–∏–ª–∏ –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É "–ü–æ –ø–ª–∞–Ω—É" / "–í—á–µ—Ä–∞ –ø–æ–≥—Ä—É–∂–µ–Ω–æ" / "–ü–ª–∞–Ω –Ω–∞ –º–µ—Å—è—Ü" */
}
.secondary-metric.month-plan .secondary-metric-label,
.secondary-metric.month-plan .secondary-metric-value {
    font-size: var(--font-size-md);       /* —á—É—Ç—å –∫—Ä—É–ø–Ω–µ–µ */
    font-weight: var(--font-weight-bold); /* –∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç */
}
.secondary-metric-label {
    color: var(--text-secondary);
    font-weight: var(--font-weight-medium);
}

.secondary-metric-value {
    font-weight: var(--font-weight-semibold);
    color: var(--text-primary);
}
/* –í—á–µ—Ä–∞—à–Ω—è—è –ø–æ–≥—Ä—É–∑–∫–∞: –∫–ª–∏–∫ –∏ —Å–ø–∏—Å–æ–∫ —Å—Ç–∞–Ω—Ü–∏–π */
#toggleLoadingYesterday {
    cursor: pointer;
    text-decoration: underline dotted;
}

#toggleLoadingYesterday:hover {
    color: var(--navy-primary);
}

.loading-yesterday-panel {
    margin-top: var(--space-8);
    padding-top: var(--space-8);
    border-top: 1px dashed rgba(148, 163, 184, 0.6);
    font-size: var(--font-size-xs);
}

.loading-yesterday-list {
    list-style: none;
    margin: 0;
    padding: 0;
}

.loading-yesterday-list li {
    margin-bottom: 2px;
}

/* Debt card specific */
.debt-amount {
    display: flex;
    flex-direction: column;
    gap: var(--space-12);
}

.debt-item {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
}

.debt-label {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    font-weight: var(--font-weight-medium);
}

.debt-value {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
}

.debt-value.total {
    color: var(--navy-primary);
}

.debt-value.overdue {
    color: var(--warning-orange);
}

.progress-fill.warning {
    background: linear-gradient(90deg, var(--warning-orange), #ff9a62);
}
/* Receivables by client (drilldown) */
.clients-overdue-toggle {
    margin-top: var(--space-12);
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.clients-overdue-toggle:hover {
    color: var(--navy-primary);
}

.clients-overdue-panel {
    margin-top: var(--space-12);
    padding-top: var(--space-8);
    border-top: 1px dashed rgba(148, 163, 184, 0.6);
}

.clients-overdue-panel.hidden {
    display: none;
}

.clients-table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--font-size-xs);
}

.clients-table th,
.clients-table td {
    padding: 4px 6px;
}

.clients-table th {
    text-align: left;
    font-weight: var(--font-weight-semibold);
    color: var(--text-secondary);
    border-bottom: 1px solid rgba(148, 163, 184, 0.3);
}

.clients-table td.amount,
.clients-table td.percent {
    text-align: right;
    white-space: nowrap;
}

.clients-table td.percent {
    color: var(--warning-orange);
}

.clients-table tr:nth-child(even) {
    background-color: rgba(15, 23, 42, 0.02);
}

/* Repairs card specific */
.repair-breakdown {
    display: flex;
    flex-direction: column;
    gap: var(--space-16);
}

.repair-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-12);
    background: var(--bg-light);
    border-radius: var(--radius-base);
    border-left: 4px solid var(--navy-primary);
}

.repair-item:nth-child(1) {
    border-left-color: var(--success-green);
}

.repair-item:nth-child(2) {
    border-left-color: var(--warning-orange);
}

.repair-item:nth-child(3) {
    border-left-color: var(--gold-accent);
}

.repair-info {
    display: flex;
    flex-direction: column;
}

.repair-type {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-bold);
    color: var(--navy-primary);
}

.repair-description {
    font-size: 11px;
    color: var(--text-secondary);
}

.repair-stats {
    text-align: right;
}
.repairs-card {
  margin-top: 10mm; /* –Ω—É–∂–Ω—ã–π —Ç–µ–±–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –∑–∞–∑–æ—Ä –ø–æ—Å–ª–µ "–ü–ª–∞–Ω –Ω–∞ –º–µ—Å—è—Ü" */
}

.repair-count {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--navy-primary);
}

.repair-percent {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
}

/* Chart Section ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é */
.chart-section {
    display: none; /* –≥—Ä–∞—Ñ–∏–∫ –∏ –≤–µ—Å—å –±–ª–æ–∫ –±–æ–ª—å—à–µ –Ω–µ –≤–∏–¥–µ–Ω –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ */

    /* –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å –ø–æ –∂–µ–ª–∞–Ω–∏—é */
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: var(--space-24);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    flex-direction: column;
    gap: var(--space-16);
}

.chart-header {
    margin-bottom: var(--space-24);
    padding-bottom: var(--space-16);
    border-bottom: 2px solid var(--border-color);
}

.chart-title {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--navy-primary);
}

.chart-container {
    height: 300px;
    position: relative;
}

/* Responsive */
@media (max-width: 768px) {
    .dashboard-container {
        padding: var(--space-16);
    }

    .header-content {
        flex-direction: column;
        align-items: flex-start;
    }

    .header-right {
        text-align: left;
        width: 100%;
    }

    .last-update {
        justify-content: flex-start;
    }

    .metrics-grid {
        grid-template-columns: 1fr;
    }

    .main-metric {
        font-size: 36px;
    }

    .company-info h1 {
        font-size: var(--font-size-2xl);
    }
}

@media (max-width: 480px) {
    .dashboard-header {
        padding: var(--space-16);
    }

    .metric-card {
        padding: var(--space-16);
    }

    .main-metric {
        font-size: 32px;
    }
}
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <div class="company-info">
                    <h1>–û–û–û "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –ö–æ–º–ø–∞–Ω–∏—è '–í–ï–õ–ï–°'"</h1>
                    <p class="subtitle">–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –¥–∞—à–±–æ—Ä–¥</p>
                </div>
                <div class="header-right">
                    <div class="current-datetime" id="currentDateTime">‚Äî</div>
                    <div class="data-updated">
                        <span>üïí</span>
                        <span id="dataUpdatedAt">–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ‚Äî</span>
                    </div>
                    <button class="refresh-btn" onclick="refreshData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                </div>

            </div>
        </header>

        <!-- Metrics Grid -->
        <div class="metrics-grid">
            <!-- Card 1: Loading -->
            <div class="metric-card">
                <div class="card-header">
                     <div class="card-icon">üì¶</div>
                     <div class="card-header-text">
                         <h2 class="card-title">–ü–û–ì–†–£–ó–ö–ê</h2>
                         <div class="last-update last-update-inline">
                             <span>‚è±</span>
                             <span id="lastUpdate">–ü–æ–≥—Ä—É–∑–∫–∞ —Å ‚Äî –ø–æ ‚Äî</span>
                         </div>
                     </div>
                 </div>
                 <div class="card-body">

                    <div class="main-metric" id="loadedWagonsMonth">‚Äî</div>
                    <div class="metric-label">–ü–æ–≥—Ä—É–∂–µ–Ω–æ –≤–∞–≥–æ–Ω–æ–≤ (–º–µ—Å—è—Ü)</div>
                    
                    <div class="progress-section">
                        <div class="progress-info">
                            <span class="progress-label">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞</span>
                            <span class="progress-value" id="progressPercent">‚Äî</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                        <div class="secondary-metric month-plan">
                            <span class="secondary-metric-label">–ü–æ –ø–ª–∞–Ω—É:</span>
                            <span class="secondary-metric-value" id="planMonth">‚Äî</span>
                        </div>
                        
                        <div class="secondary-metric month-plan">
                            <span class="secondary-metric-label" id="toggleLoadingYesterday">–í—á–µ—Ä–∞ –ø–æ–≥—Ä—É–∂–µ–Ω–æ:</span>
                            <span class="secondary-metric-value" id="loadedYesterday">‚Äî</span>
                        </div>
                        
                        <div id="loadingYesterdayPanel" class="loading-yesterday-panel hidden">
                            <ul id="loadingYesterdayList" class="loading-yesterday-list"></ul>
                        </div>
                        
                        <div class="secondary-metric month-plan">
                            <span class="secondary-metric-label">–ü–ª–∞–Ω –Ω–∞ –º–µ—Å—è—Ü:</span>
                            <span class="secondary-metric-value" id="fullMonthPlan">‚Äî</span>
                        </div>
                      <!-- Card 3: Repairs -->
                      <div class="metric-card repairs-card">
                        <div class="card-header">
                          <div class="card-icon">üõ†Ô∏è</div>
                          <div class="card-header-text">
                            <div class="card-title-row">
                              <h2 class="card-title">–†–ï–ú–û–ù–¢–´</h2>
                              <span id="repairsHeaderSummary" class="metric-value card-title-suffix"></span>
                            </div>
                            <div id="repairsDate" class="metric-label"></div>
                          </div>
                        </div>

                        <div class="card-body">
                          <div id="repairsTotalsList" class="repairs-totals-grid"></div>
            
                          <div class="metric-row mt-2">
                            <button id="toggleRepairsTable" class="link-button">
                              ‚ñº –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ —Ä–µ–º–æ–Ω—Ç–∞–º
                            </button>
                          </div>
            
                          <div id="repairsTablePanel" class="hidden">
                            <table class="metric-table">
                              <thead>
                                <tr>
                                  <th>–í–∏–¥ —Ä–µ–º–æ–Ω—Ç–∞</th>
                                  <th>–í —Ä–µ–º–æ–Ω—Ç–µ</th>
                                  <th>–í –ø—É—Ç–∏</th>
                                  <th>–í –æ–∂–∏–¥–∞–Ω–∏–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</th>
                                  <th>–í –æ–∂–∏–¥–∞–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏</th>
                                  <th>–ò—Ç–æ–≥–æ</th>
                                </tr>
                              </thead>
                              <tbody id="repairsTableBody"></tbody>
                            </table>
                          </div>
            
                          <div class="metric-row mt-2">
                            <span class="metric-label">–í—Å–µ–≥–æ –≤–∞–≥–æ–Ω–æ–≤ –≤ –ø–∞—Ä–∫–µ:</span>
                            <span class="metric-value" id="fleetTotal">‚Äî</span>
                          </div>
                        </div>
                      </div>

                    </div>
            </div>
<!-- Card: Receivables (–î–µ–±–∏—Ç–æ—Ä–∫–∞) + Payables (–ö—Ä–µ–¥–∏—Ç–æ—Ä–∫–∞) -->
<div class="metric-card">
<div class="card-header">
  <div class="card-icon">üí≥</div>
  <div class="card-header-text">
    <h2 class="card-title">–ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨</h2>
    <!-- –û—Å—Ç–∞—Ç–∫–∏ –î–° —Å—Ä–∞–∑—É –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º -->
   <div id="cashSummary" class="card-subtitle"></div>
  </div>
</div>

<div class="card-body">

    <!-- == –ë–õ–û–ö 1: –î–ï–ë–ò–¢–û–†–°–ö–ê–Ø –ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨ == -->
    <div class="subsection-header">
      <span class="metric-label"><strong>–î–µ–±–∏—Ç–æ—Ä—Å–∫–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å</strong></span>
      <span id="receivablesDate" class="metric-label"></span>
    </div>

    <!-- –û–±—â–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å -->
    <div class="metric-row">
      <span class="metric-label">–û–±—â–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å:</span>
      <span id="totalDebt" class="metric-value">0 –º–ª–Ω. —Ä.</span>
    </div>

    <!-- –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è -->
    <div class="metric-row">
      <span class="metric-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è:</span>
      <span id="overdueDebt" class="metric-value text-accent">0 –º–ª–Ω. —Ä.</span>
    </div>

    <!-- –î–æ–ª—è –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–π -->
    <div class="metric-row">
      <span class="metric-label">–î–æ–ª—è –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–π</span>
      <span id="overduePercent" class="metric-value text-accent">0%</span>
    </div>

    <div class="progress-bar">
      <div id="overdueProgressFill" class="progress-fill warning"></div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º -->
    <div class="metric-row mt-2">
      <button id="toggleClientsOverdue" class="link-button">
        ‚ñº –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º
      </button>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–π –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º -->
    <div id="clientsOverduePanel" class="hidden">
      <table class="metric-table">
        <thead>
          <tr>
            <th>–ö–ª–∏–µ–Ω—Ç</th>
            <th>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è</th>
            <th>%</th>
          </tr>
        </thead>
        <tbody id="clientsOverdueBody"></tbody>
      </table>
    </div>

    <!-- –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è -->
    <div class="metric-row mt-4">
      <span class="metric-label">–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è:</span>
      <span id="paymentsTotal" class="metric-value">0 –º–ª–Ω. —Ä.</span>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞: –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º -->
    <div class="metric-row mt-1">
      <button id="toggleClientsPayments" class="link-button">
        ‚ñº –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º
      </button>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å: –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º -->
    <div id="clientsPaymentsPanel" class="hidden">
      <table class="metric-table">
        <thead>
          <tr>
            <th>–ö–ª–∏–µ–Ω—Ç</th>
            <th>–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</th>
            <th>%</th>
          </tr>
        </thead>
        <tbody id="clientsPaymentsBody"></tbody>
      </table>
    </div>

    <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É –¥–µ–±–∏—Ç–æ—Ä–∫–æ–π –∏ –∫—Ä–µ–¥–∏—Ç–æ—Ä–∫–æ–π -->
    <div class="mt-4" style="border-top: 1px dashed rgba(148, 163, 184, 0.6); padding-top: var(--space-16);">

      <!-- == –ë–õ–û–ö 2: –ö–†–ï–î–ò–¢–û–†–°–ö–ê–Ø –ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–¨ == -->
      <div class="subsection-header">
        <span class="metric-label"><strong>–ö—Ä–µ–¥–∏—Ç–æ—Ä—Å–∫–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å</strong></span>
        <span id="payablesDate" class="metric-label"></span>
      </div>

      <div class="metric-row">
        <span class="metric-label">–û–±—â–∏–π –¥–æ–ª–≥:</span>
        <span id="apTotalDebt" class="metric-value">0 –º–ª–Ω. —Ä.</span>
      </div>

       <!-- –ö–Ω–æ–ø–∫–∞: –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏ —Å –¥–æ–ª–≥–æ–º > 1 –º–ª–Ω -->
      <div class="metric-row mt-2">
        <button id="toggleSuppliersPayables" class="link-button">
          ‚ñº –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º (&gt; 1 –º–ª–Ω)
        </button>
      </div>

      <div id="suppliersPayablesPanel" class="hidden">
        <table class="metric-table">
          <thead>
            <tr>
              <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
              <th>–î–æ–ª–≥</th>
              <th>MAX –æ—Ç—Å—Ä–æ—á–∫–∞, –¥–Ω–µ–π</th>
            </tr>
          </thead>
          <tbody id="suppliersPayablesBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Card: –ë—é–¥–∂–µ—Ç -->
<div class="metric-card" id="budget-card">
  <div class="card-header">
    <div class="card-icon">üí∞</div>
    <div class="card-header-text">
      <h2 class="card-title">–ë–Æ–î–ñ–ï–¢</h2>
      <div id="budgetSubtitle" class="metric-label"></div>
    </div>
  </div>

    <div class="subsection-header">
      <span class="metric-label budget-service-title">
        <strong>–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è —Å–ª—É–∂–±–∞</strong>
      </span>
      <span id="budgetProdMonths" class="metric-label"></span>
    </div>

    <div class="metric-row">
      <span class="metric-label">–†–∞—Å—Ö–æ–¥—ã —Ä–µ–º–æ–Ω—Ç (–ø–ª–∞–Ω / —Ñ–∞–∫—Ç):</span>
      <span class="metric-value" id="budgetProdExpSummary">‚Äî / ‚Äî</span>
    </div>

    <div class="metric-row">
      <span class="metric-label">–†–∞—Å—Ö–æ–¥—ã —Ç–∞—Ä–∏—Ñ (–ø–ª–∞–Ω / —Ñ–∞–∫—Ç):</span>
      <span class="metric-value" id="budgetProdRevSummary">‚Äî / ‚Äî</span>
    </div>

    <div class="metric-row mt-2">
      <button id="toggleBudgetProd" class="link-button">
        ‚ñº –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–π —Å–ª—É–∂–±—ã
      </button>
    </div>

        <div id="budgetProdPanel" class="hidden">
      <div class="budget-grid">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Ä–∞—Å—Ö–æ–¥—ã -->
        <div>
          <h4 class="subsection-header">–†–∞—Å—Ö–æ–¥—ã</h4>
          <table class="metric-table">
             <thead>
                <tr>
                  <th>–°—Ç–∞—Ç—å—è</th>
                  <th class="amount">–ü–ª–∞–Ω, —à—Ç</th>
                  <th class="amount">–§–∞–∫—Ç, —à—Ç</th>
                  <th class="amount">–ü–ª–∞–Ω</th>
                  <th class="amount">–§–∞–∫—Ç</th>
                </tr>
              </thead>

            <tbody id="budgetProdExpBody"></tbody>
          </table>

          <h4 class="subsection-header mt-4">–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (—Ä–µ–º–æ–Ω—Ç)</h4>
          <table class="metric-table">
            <thead>
              <tr>
                <th>–°—Ç–∞—Ç—å—è</th>
                <th class="amount">–ü–ª–∞–Ω, —Ä.</th>
                <th class="amount">–§–∞–∫—Ç, —Ä.</th>
              </tr>
            </thead>
            <tbody id="budgetProdExpAvgBody"></tbody>
          </table>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –¢–∞—Ä–∏—Ñ -->
        <div>
          <h4 class="subsection-header">–¢–∞—Ä–∏—Ñ</h4>
          <table class="metric-table">
            <thead>
              <tr>
                <th>–°—Ç–∞—Ç—å—è</th>
                <th class="amount">–ü–ª–∞–Ω</th>
                <th class="amount">–§–∞–∫—Ç</th>
              </tr>
            </thead>
            <tbody id="budgetProdRevBody"></tbody>
          </table>

          <h4 class="subsection-header mt-4">–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (—Ç–∞—Ä–∏—Ñ)</h4>
          <table class="metric-table">
            <thead>
              <tr>
                <th>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th>
                <th class="amount">–ü–ª–∞–Ω, —Ä.</th>
                <th class="amount">–§–∞–∫—Ç, —Ä.</th>
              </tr>
            </thead>
            <tbody id="budgetProdRevAvgBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è —Å–ª—É–∂–±–∞ -->
    <div class="subsection-header mt-4">
      <span class="metric-label budget-service-title">
        <strong>–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è —Å–ª—É–∂–±–∞</strong>
      </span>
      <span id="budgetCommMonths" class="metric-label"></span>
    </div>
    
    <div class="metric-row">
      <span class="metric-label">–ú–∞—Ä–∂–∞ (–ø–ª–∞–Ω / —Ñ–∞–∫—Ç):</span>
      <span class="metric-value" id="budgetCommSummary">‚Äî / ‚Äî</span>
    </div>
    
    <div class="metric-row">
      <span class="metric-label">–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –≤–∞–≥–æ–Ω–∞ (–ø–ª–∞–Ω / —Ñ–∞–∫—Ç):</span>
      <span class="metric-value" id="budgetCommYield">‚Äî / ‚Äî</span>
    </div>
    
    <div class="metric-row mt-2">
      <button id="toggleBudgetComm" class="link-button">
        ‚ñº –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–π —Å–ª—É–∂–±—ã
      </button>
    </div>
    
<div id="budgetCommPanel" class="hidden">
  <table class="simple-table">
    <thead>
      <tr>
        <th class="text-left">–ü—Ä–æ–¥—É–∫—Ç</th>
        <th class="text-right">–ü–ª–∞–Ω, –≤–∞–≥.</th>
        <th class="text-right">–§–∞–∫—Ç, –≤–∞–≥.</th>
      </tr>
    </thead>
    <tbody id="budgetCommNatBody">
      <!-- —Å—é–¥–∞ JS –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å —Å—Ç—Ä–æ–∫–∏ –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º -->
    </tbody>
    <tfoot>
      <tr class="total-row">
        <td class="text-left"><strong>–ò—Ç–æ–≥–æ</strong></td>
        <td class="text-right" id="budgetCommNatPlanTotal">‚Äî</td>
        <td class="text-right" id="budgetCommNatFactTotal">‚Äî</td>
      </tr>
    </tfoot>
  </table>
</div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
'use strict';


// ==========================
// 1. –°–°–´–õ–ö–ê –ù–ê GOOGLE SHEETS
// ==========================
// –í–°–¢–ê–í–¨ —Å—é–¥–∞ —Å–≤–æ—é CSV-—Å—Å—ã–ª–∫—É —Å output=csv
const SHEET_CSV_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRy08FvutySDNk8yvn0QKdT92-uWjRqaxqi2057Tl42Ai2zLS4L833E2g2GdgBnpFX-t5uwX6JUcmg4/pub?gid=1433292947&single=true&output=csv';
// ar_agg_client_contract (–ù–û–í–ê–Ø —Å—Å—ã–ª–∫–∞, —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ—Å—Ä–æ—á–∫–∏)
const SHEET_CLIENTS_CSV_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRy08FvutySDNk8yvn0QKdT92-uWjRqaxqi2057Tl42Ai2zLS4L833E2g2GdgBnpFX-t5uwX6JUcmg4/pub?gid=57311955&single=true&output=csv';
const SHEET_PAYMENTS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRy08FvutySDNk8yvn0QKdT92-uWjRqaxqi2057Tl42Ai2zLS4L833E2g2GdgBnpFX-t5uwX6JUcmg4/pub?gid=740110225&single=true&output=csv';
const SHEET_REPAIRS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRy08FvutySDNk8yvn0QKdT92-uWjRqaxqi2057Tl42Ai2zLS4L833E2g2GdgBnpFX-t5uwX6JUcmg4/pub?gid=1619190380&single=true&output=csv';
const SHEET_AP_SUPPLIERS_CSV_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vQGmHCtGV63YTyIyH-st7Rs43FQq47sz466WxHjNmqM7FXgj422K5qHY2rK4SCalmqDPR6aTiTts-A4/pub?gid=579148005&single=true&output=csv'; // ap_suppliers: –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å –ø–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º
const SHEET_LOADING_JOURNAL_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRy08FvutySDNk8yvn0QKdT92-uWjRqaxqi2057Tl42Ai2zLS4L833E2g2GdgBnpFX-t5uwX6JUcmg4/pub?gid=1603902040&single=true&output=csv';
const SHEET_CASH_CSV_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRy08FvutySDNk8yvn0QKdT92-uWjRqaxqi2057Tl42Ai2zLS4L833E2g2GdgBnpFX-t5uwX6JUcmg4/pub?gid=676880520&single=true&output=csv';  
const SHEET_BUDGET_PROD_CSV_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vTJnp26wsUwxKZuBiPBGPpH1x1iIbvQvq1kJ1Z3l2YPARbiSsve1TOGteDxt-33auDN1h7ndNKfrq3m/pub?gid=0&single=true&output=csv';
// –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è —Å–ª—É–∂–±–∞: kpi (–º–∞—Ä–∂–∞, –≤–∞–≥–æ–Ω–æ-—Å—É—Ç–∫–∏, –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å)
const SHEET_COMM_KPI_CSV_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vTJnp26wsUwxKZuBiPBGPpH1x1iIbvQvq1kJ1Z3l2YPARbiSsve1TOGteDxt-33auDN1h7ndNKfrq3m/pub?gid=463811978&single=true&output=csv';
// –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è —Å–ª—É–∂–±–∞: –Ω–∞—Ç—É—Ä–∫–∞ –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º (–ü–µ—Å–æ–∫/–¶–µ–º–µ–Ω—Ç/–ü–í)
const SHEET_COMM_NAT_CSV_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vTJnp26wsUwxKZuBiPBGPpH1x1iIbvQvq1kJ1Z3l2YPARbiSsve1TOGteDxt-33auDN1h7ndNKfrq3m/pub?gid=78706492&single=true&output=csv';


    
let dashboardData = null;
let trendChart = null;
let receivablesByClient = [];   // —Å—é–¥–∞ –ø–æ–ª–æ–∂–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ—Å—Ä–æ—á–∫–∏ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º
let paymentsLastDate = null;
let paymentsByClient = []; // [{ client, amount }]
let payablesBySupplier = []; // [{ supplier, total, avg_overdue }]
let yesterdayLoadingStations = []; // [{ station, count }]
let yesterdayLoadingDate = null;
let budgetProduction = null; // –±—é–¥–∂–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–π —Å–ª—É–∂–±—ã
let budgetCommercial = null;  // –±—é–¥–∂–µ—Ç –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–π —Å–ª—É–∂–±—ã

// ==========================
// 2. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
// ==========================
function buildCashFromRows(rows) {
  if (!rows || rows.length < 2) return null;

  const header = rows[0];
  const idxDate  = header.indexOf('as_of_date');
  const idxTotal = header.indexOf('cash_total');

  if (idxDate === -1 || idxTotal === -1) {
    console.warn('cash_balances: –Ω–µ—Ç –∫–æ–ª–æ–Ω–æ–∫ as_of_date / cash_total');
    return null;
  }

  let maxDate = null;
  let lastRow = null;

  for (let i = 1; i < rows.length; i++) {
    const row = rows[i];
    if (!row || !row.length) continue;

    const d = parseDate(row[idxDate]);
    if (!d) continue;

    if (!maxDate || d > maxDate) {
      maxDate = d;
      lastRow = row;
    }
  }

  if (!lastRow || !maxDate) return null;

  const total = toNumber(lastRow[idxTotal]);

  return {
    date: maxDate,
    total: total
  };
}
function buildBudgetProductionFromRows(rows) {
  // –û–∂–∏–¥–∞–µ–º CSV —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏:
  // year, month, months_total, section, line_code, line_name, plan, fact, order
  if (!rows || rows.length < 2) return null;

  const header = rows[0];
  const idxYear        = header.indexOf('year');
  const idxMonth       = header.indexOf('month');
  const idxMonthsTotal = header.indexOf('months_total');
  const idxSection     = header.indexOf('section');
  const idxCode        = header.indexOf('line_code');
  const idxName        = header.indexOf('line_name');
  const idxPlan        = header.indexOf('plan');
  const idxFact        = header.indexOf('fact');
  const idxOrder       = header.indexOf('order');
  const idxQtyPlan     = header.indexOf('qty_plan');
  const idxQtyFact     = header.indexOf('qty_fact');


  if (idxYear === -1 || idxMonth === -1 || idxSection === -1 || idxCode === -1) {
    console.warn('budget_production: –Ω–µ—Ç –Ω—É–∂–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ (year, month, section, line_code)');
    return null;
  }

  const normalizedRows = [];
  let maxKey = null;

  for (let i = 1; i < rows.length; i++) {
    const row = rows[i];
    if (!row || !row.length) continue;

    const year  = Number(row[idxYear])  || 0;
    const month = Number(row[idxMonth]) || 0;
    if (!year || !month) continue;

    const key = year * 12 + month;

        const item = {
      year,
      month,
      key,
      monthsTotal: idxMonthsTotal !== -1 ? Number(row[idxMonthsTotal]) || null : null,
      section: String(idxSection !== -1 ? row[idxSection] : '').trim(),
      code:    String(idxCode    !== -1 ? row[idxCode]    : '').trim(),
      name:
        idxName !== -1 && row[idxName]
          ? String(row[idxName]).trim()
          : String(row[idxCode] || '').trim(),
      plan:    idxPlan    !== -1 ? toNumber(row[idxPlan])    : 0,
      fact:    idxFact    !== -1 ? toNumber(row[idxFact])    : 0,
      order:   idxOrder   !== -1 ? Number(row[idxOrder]) || 0 : 0,
      qtyPlan: idxQtyPlan !== -1 ? toNumber(row[idxQtyPlan]) : null,
      qtyFact: idxQtyFact !== -1 ? toNumber(row[idxQtyFact]) : null
    };

    normalizedRows.push(item);

    if (maxKey === null || key > maxKey) {
      maxKey = key;
    }
  }

  if (!normalizedRows.length || maxKey === null) return null;

  const latestRows = normalizedRows.filter(r => r.key === maxKey);
  if (!latestRows.length) return null;

  const any = latestRows[0];
  const period = {
    year: any.year,
    month: any.month,
    monthsTotal: any.monthsTotal
  };

  function pickSection(sectionName) {
    return latestRows
      .filter(r => r.section === sectionName)
      .sort((a, b) => a.order - b.order || a.name.localeCompare(b.name, 'ru'));
  }

  const expensesMain  = pickSection('expenses_main');
  const expensesOther = pickSection('expenses_other');
  const expensesTotal = pickSection('expenses_total');
  const expensesAvg   = pickSection('expenses_avg');
  const revenue       = pickSection('revenue');
  const revenueAvg    = pickSection('revenue_avg');

  // --- –ò—Ç–æ–≥ –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º (—Ä–µ–º–æ–Ω—Ç): –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–∫—É TOTAL_EXP, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å ---
  let expSummary = null;
  if (expensesTotal && expensesTotal.length) {
    const totalRow =
      expensesTotal.find(r => r.code === 'TOTAL_EXP') || expensesTotal[0];

    expSummary = {
      plan: totalRow.plan || 0,
      fact: totalRow.fact || 0,
      name: totalRow.name || '–ò—Ç–æ–≥–æ —Ä–∞—Å—Ö–æ–¥—ã'
    };
  } else {
    // –µ—Å–ª–∏ —Å–µ–∫—Ü–∏–∏ expenses_total –Ω–µ—Ç ‚Äî —Å—É–º–º–∏—Ä—É–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤
    const allExpenses = expensesMain.concat(expensesOther);
    const sumExpPlan = allExpenses.reduce((s, r) => s + (r.plan || 0), 0);
    const sumExpFact = allExpenses.reduce((s, r) => s + (r.fact || 0), 0);

    expSummary = {
      plan: sumExpPlan,
      fact: sumExpFact,
      name: '–ò—Ç–æ–≥–æ —Ä–∞—Å—Ö–æ–¥—ã'
    };
  }

  // --- –ò—Ç–æ–≥ –ø–æ —Ç–∞—Ä–∏—Ñ—É/–¥–æ—Ö–æ–¥–∞–º: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–∫—É TOTAL_REV, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å ---
  let revSummary = null;
  if (revenue && revenue.length) {
    const totalRevRow = revenue.find(r => r.code === 'TOTAL_REV');

    if (totalRevRow) {
      revSummary = {
        plan: totalRevRow.plan || 0,
        fact: totalRevRow.fact || 0,
        name: totalRevRow.name || '–í—ã—Ä—É—á–∫–∞ –≤—Å–µ–≥–æ'
      };
    } else {
      const sumRevPlan = revenue.reduce((s, r) => s + (r.plan || 0), 0);
      const sumRevFact = revenue.reduce((s, r) => s + (r.fact || 0), 0);

      revSummary = {
        plan: sumRevPlan,
        fact: sumRevFact,
        name: '–í—ã—Ä—É—á–∫–∞ –≤—Å–µ–≥–æ'
      };
    }
  }

  return {
    period,
    expensesMain,
    expensesOther,
    expensesTotal,
    expensesAvg,
    revenue,
    revenueAvg,
    expSummary,
    revSummary
  };
}

function buildBudgetCommercialFromRows(kpiRows, natRows) {
  if (!kpiRows || kpiRows.length < 2) {
    console.warn('comm_kpi: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
    return null;
  }

  const hdr = kpiRows[0];
  const idxYear       = hdr.indexOf('year');
  const idxMonth      = hdr.indexOf('month');
  const idxMPlan      = hdr.indexOf('margin_plan');
  const idxMFact      = hdr.indexOf('margin_fact');
  const idxWDPlan     = hdr.indexOf('wagon_days_plan');
  const idxWDFact     = hdr.indexOf('wagon_days_fact');

  if (idxYear === -1 || idxMonth === -1 || idxMPlan === -1 || idxMFact === -1) {
    console.warn('comm_kpi: –Ω–µ—Ç –Ω—É–∂–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ (year, month, margin_plan, margin_fact)');
    return null;
  }

  const kpiItems = [];
  let maxFactKey = null;
  let maxPlanKey = null;

  for (let i = 1; i < kpiRows.length; i++) {
    const row = kpiRows[i];
    if (!row || !row.length) continue;

    const year  = Number(row[idxYear])  || 0;
    const month = Number(row[idxMonth]) || 0;
    if (!year || !month) continue;

    const key = year * 12 + month;

    const marginPlan = idxMPlan  !== -1 ? toNumber(row[idxMPlan])  : 0;
    const marginFact = idxMFact  !== -1 ? toNumber(row[idxMFact])  : 0;
    const wdPlan     = idxWDPlan !== -1 ? toNumber(row[idxWDPlan]) : 0;
    const wdFact     = idxWDFact !== -1 ? toNumber(row[idxWDFact]) : 0;

    const item = {
      year,
      month,
      key,
      marginPlan,
      marginFact,
      wagonDaysPlan: wdPlan,
      wagonDaysFact: wdFact
    };
    kpiItems.push(item);

    if (marginFact) {
      if (maxFactKey === null || key > maxFactKey) maxFactKey = key;
    }
    if (marginPlan) {
      if (maxPlanKey === null || key > maxPlanKey) maxPlanKey = key;
    }
  }

  if (!kpiItems.length) return null;

  const usedKey = maxFactKey !== null ? maxFactKey : maxPlanKey;
  if (usedKey === null) {
    console.warn('comm_kpi: –Ω–µ—Ç –Ω–µ–Ω—É–ª–µ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ø–ª–∞–Ω/—Ñ–∞–∫—Ç');
    return null;
  }

  const usedItems = kpiItems.filter(r => r.key <= usedKey);
  const lastItem  = kpiItems.find(r => r.key === usedKey);

  let marginPlanTotal = 0;
  let marginFactTotal = 0;
  let wdPlanTotal     = 0;
  let wdFactTotal     = 0;

  usedItems.forEach(r => {
    marginPlanTotal += r.marginPlan      || 0;
    marginFactTotal += r.marginFact      || 0;
    wdPlanTotal     += r.wagonDaysPlan   || 0;
    wdFactTotal     += r.wagonDaysFact   || 0;
  });

  const yieldPlan = wdPlanTotal ? marginPlanTotal / wdPlanTotal : null;
  const yieldFact = wdFactTotal ? marginFactTotal / wdFactTotal : null;

  const uniqueKeys = new Set();
  usedItems.forEach(r => uniqueKeys.add(r.key));
  const monthsTotal = uniqueKeys.size;

  // ===== –ù–ê–¢–£–†–ê (–ü–µ—Å–æ–∫ / –¶–µ–º–µ–Ω—Ç / –ü–í) =====
  let natByProduct = [];
  let natTotal = null;

  if (natRows && natRows.length > 1) {
    const hNat      = natRows[0];
    const idxNYear  = hNat.indexOf('year');
    const idxNMonth = hNat.indexOf('month');
    const idxCode   = hNat.indexOf('product_code');
    const idxName   = hNat.indexOf('product_name');
    const idxWPlan  = hNat.indexOf('wagons_plan');
    const idxWFact  = hNat.indexOf('wagons_fact');

    if (idxNYear === -1 || idxNMonth === -1 || idxCode === -1) {
      console.warn('comm_nat: –Ω–µ—Ç –Ω—É–∂–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ (year, month, product_code)');
    } else {
      const prodMap = new Map();

      for (let i = 1; i < natRows.length; i++) {
        const row = natRows[i];
        if (!row || !row.length) continue;

        const y  = Number(row[idxNYear])  || 0;
        const m  = Number(row[idxNMonth]) || 0;
        if (!y || !m) continue;

        const keyN = y * 12 + m;
        if (keyN > usedKey) continue; // –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –º–µ—Å—è—Ü—ã –¥–æ usedKey

        const code = row[idxCode];
        if (!code) continue;

        const name = idxName !== -1 && row[idxName]
          ? String(row[idxName]).trim()
          : String(code).trim();

        const wPlan = idxWPlan !== -1 ? toNumber(row[idxWPlan]) : 0;
        const wFact = idxWFact !== -1 ? toNumber(row[idxWFact]) : 0;

        const prodKey = String(code).trim();
        let obj = prodMap.get(prodKey);
        if (!obj) {
          obj = { code: prodKey, name, wagonsPlan: 0, wagonsFact: 0 };
          prodMap.set(prodKey, obj);
        }
        obj.wagonsPlan += wPlan;
        obj.wagonsFact += wFact;
      }

      natByProduct = Array.from(prodMap.values());
      natByProduct.sort((a, b) => a.name.localeCompare(b.name, 'ru'));

      const totalPlan = natByProduct.reduce((s, r) => s + (r.wagonsPlan || 0), 0);
      const totalFact = natByProduct.reduce((s, r) => s + (r.wagonsFact || 0), 0);
      natTotal = { code: 'TOTAL', name: '–ò—Ç–æ–≥–æ', wagonsPlan: totalPlan, wagonsFact: totalFact };
    }
  }

  return {
    period: lastItem
      ? { year: lastItem.year, month: lastItem.month, monthsTotal }
      : { year: null, month: null, monthsTotal },
    margin: {
      plan:           marginPlanTotal,
      fact:           marginFactTotal,
      wagonDaysPlan:  wdPlanTotal,
      wagonDaysFact:  wdFactTotal,
      yieldPlan,
      yieldFact
    },
    nat: {
      byProduct: natByProduct,
      total: natTotal
    }
  };
}

    
function buildPaymentsFromRows(rows) {
    if (!rows || rows.length < 2) return { lastDate: null, items: [] };

    const header = rows[0];
    const idxAsOf   = header.indexOf('as_of_date');
    const idxClient = header.indexOf('client_name');
    const idxTotal  = header.indexOf('total_received');

    if (idxAsOf === -1 || idxClient === -1 || idxTotal === -1) {
        console.warn('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω—É–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ ar_payments_daily');
        return { lastDate: null, items: [] };
    }

    let maxDate = null;
    const byDate = {};

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (!row || !row.length) continue;

        const asOfRaw = row[idxAsOf];
        const client  = row[idxClient];
        const total   = toNumber(row[idxTotal]);

        if (!asOfRaw || !client) continue;

        const d = parseDate(asOfRaw);
        if (!d) continue;

        if (!maxDate || d > maxDate) {
            maxDate = d;
        }

        const key = startOfDay(d).getTime();
        if (!byDate[key]) byDate[key] = [];
        byDate[key].push({
            client: client,
            amount: total
        });
    }

    if (!maxDate) return { lastDate: null, items: [] };

    const lastKey = startOfDay(maxDate).getTime();
    let items = byDate[lastKey] || [];

    // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –Ω–µ–Ω—É–ª–µ–≤–æ–π —Å—É–º–º–æ–π
    items = items.filter(it => it.amount !== 0);

    // —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é –æ–ø–ª–∞—Ç—ã
    items.sort((a, b) => b.amount - a.amount);

    return { lastDate: maxDate, items };
}

function toNumber(value) {
    if (value === undefined || value === null || value === '') return 0;
    const normalized = String(value).replace(/\s+/g, '').replace(',', '.');
    const n = Number(normalized);
    return isNaN(n) ? 0 : n;
}

function parseCSV(csvText) {
  const lines = csvText.trim().split(/\r?\n/);

  return lines.map((line) => {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const ch = line[i];

      if (ch === '"') {
        // —É–¥–≤–æ–µ–Ω–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –≤–Ω—É—Ç—Ä–∏ –ø–æ–ª—è
        if (inQuotes && i + 1 < line.length && line[i + 1] === '"') {
          current += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (ch === ',' && !inQuotes) {
        result.push(current.trim());
        current = '';
      } else {
        current += ch;
      }
    }

    result.push(current.trim());
    return result;
  });
}

function parseDate(dateStr) {
  if (dateStr === null || dateStr === undefined) return null;

  const raw = String(dateStr).trim();
  if (!raw) return null;

  // 1) –§–æ—Ä–º–∞—Ç YYYY-MM-DD
  let m = raw.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (m) {
    const [, y, mo, d] = m;
    return new Date(Number(y), Number(mo) - 1, Number(d));
  }

  // 2) –§–æ—Ä–º–∞—Ç DD.MM.YYYY
  m = raw.match(/^(\d{2})\.(\d{2})\.(\d{4})/);
  if (m) {
    const [, d, mo, y] = m;
    return new Date(Number(y), Number(mo) - 1, Number(d));
  }

  // 3) –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –¥–∞—Ç—ã –∏–∑ Google Sheets / Excel (–Ω–∞–ø—Ä–∏–º–µ—Ä 45985)
  const num = Number(raw.replace(',', '.'));
  if (!Number.isNaN(num)) {
    // –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Å–µ—Ä–∏–π–Ω–∞—è –¥–∞—Ç–∞
    if (num > 20000 && num < 60000) {
      const base = new Date(1899, 11, 30); // 1899-12-30
      const ms = Math.round(num * 24 * 60 * 60 * 1000);
      return new Date(base.getTime() + ms);
    }

    // –∞ –≤–æ—Ç "260", "77", "5" –∏ —Ç.–ø. ‚Äî –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–∞, –ù–ï –¥–∞—Ç—ã
    if (/^\d+(\.\d+)?$/.test(raw)) {
      return null;
    }
  }

  // 4) –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ ‚Äì —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞—Ä—Å–µ—Ä JS –¥–ª—è —Å—Ç—Ä–æ–∫ –≤—Ä–æ–¥–µ "2025/12/09"
  const d = new Date(raw);
  return isNaN(d.getTime()) ? null : d;
}

function startOfDay(d) {
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}

function formatDateDMY(d) {
    const dd = String(d.getDate()).padStart(2, '0');
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const yyyy = d.getFullYear();
    return `${dd}-${mm}-${yyyy}`;
}
function rowsToObjects(rows) {
    if (!rows.length) return [];

    const header = rows[0];
    const idxTimestamp   = header.indexOf('timestamp');
    const idxLoaded      = header.indexOf('loaded_wagons');
    const idxPlanned     = header.indexOf('planned_wagons');
    const idxTotalDebt   = header.indexOf('total_debt');
    const idxOverdueDebt = header.indexOf('overdue_debt');
    const idxTr          = header.indexOf('tr_count');
    const idxKr          = header.indexOf('kr_count');
    const idxTor         = header.indexOf('tor_count');
    const idxFleet       = header.indexOf('fleet_total');

    const result = [];

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (!row[idxTimestamp]) continue;

        const date = parseDate(row[idxTimestamp]);
        if (!date) continue;

        result.push({
            date,
            timestamp: row[idxTimestamp],
            loaded_wagons: toNumber(idxLoaded       !== -1 ? row[idxLoaded]       : 0),
            planned_wagons: toNumber(idxPlanned     !== -1 ? row[idxPlanned]     : 0),
            total_debt:     toNumber(idxTotalDebt   !== -1 ? row[idxTotalDebt]   : 0),
            overdue_debt:   toNumber(idxOverdueDebt !== -1 ? row[idxOverdueDebt] : 0),
            tr_count:       toNumber(idxTr          !== -1 ? row[idxTr]          : 0),
            kr_count:       toNumber(idxKr          !== -1 ? row[idxKr]          : 0),
            tor_count:      toNumber(idxTor         !== -1 ? row[idxTor]         : 0),
            fleet_total:    toNumber(idxFleet       !== -1 ? row[idxFleet]       : 0)
        });
    }

    return result;
}
function buildRepairsFromSnapshot(rows) {
  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏ –¥–∞–Ω–Ω—ã–µ, –∏ –¥–∞—Ç—É —Å—Ä–µ–∑–∞
  if (!rows || !rows.length) {
    return { items: [], date: null };
  }

  // 1) –ò—â–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –≤–æ –≤—Å–µ—Ö —è—á–µ–π–∫–∞—Ö —Ñ–∞–π–ª–∞ —Ä–µ–º–æ–Ω—Ç–æ–≤
  let maxDate = null;
  for (let i = 0; i < rows.length; i++) {
    const row = rows[i];
    if (!row) continue;

    for (let j = 0; j < row.length; j++) {
      const d = parseDate(row[j]);
      if (d && (!maxDate || d > maxDate)) {
        maxDate = d;
      }
    }
  }

  // 2) –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º, –≥–¥–µ –µ—Å—Ç—å "–≤–∏–¥ —Ä–µ–º–æ–Ω—Ç–∞"
  let headerRowIndex = rows.findIndex(r =>
    r && r.some(cell => cell && cell.toString().toLowerCase().includes('–≤–∏–¥ —Ä–µ–º–æ–Ω—Ç–∞'))
  );
  if (headerRowIndex === -1) {
    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å—Ç—Ä–æ–∫—É –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≤ repairs_snapshot');
    return { items: [], date: maxDate };
  }

  const hdr = rows[headerRowIndex].map(h =>
    (h || '').toString().toLowerCase().trim()
  );

  const idx = {
    type: hdr.indexOf('–≤–∏–¥ —Ä–µ–º–æ–Ω—Ç–∞'),
    r:    hdr.indexOf('–≤ —Ä–µ–º–æ–Ω—Ç–µ'),
    t:    hdr.indexOf('–≤ –ø—É—Ç–∏'),
    reg:  hdr.indexOf('–≤ –æ–∂–∏–¥–∞–Ω–∏–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –≤ —Ä–µ–º–æ–Ω—Ç'),
    disp: hdr.indexOf('–≤ –æ–∂–∏–¥–∞–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑ —Ä–µ–º–æ–Ω—Ç–∞'),
  };

  // —Å—Ç–æ–ª–±–µ—Ü —Å –∏—Ç–æ–≥–æ–º –º–æ–∂–µ—Ç –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è "–≤—Å–µ–≥–æ" –∏–ª–∏ "–∏—Ç–æ–≥–æ"
  let totalIdx = hdr.indexOf('–≤—Å–µ–≥–æ');
  if (totalIdx === -1) {
    totalIdx = hdr.indexOf('–∏—Ç–æ–≥–æ');
  }
  idx.total = totalIdx;

  if (idx.type === -1) {
    console.warn('–í repairs_snapshot –Ω–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ "–≤–∏–¥ —Ä–µ–º–æ–Ω—Ç–∞"');
    return { items: [], date: maxDate };
  }

  const items = [];

  for (let i = headerRowIndex + 1; i < rows.length; i++) {
    const r = rows[i];
    if (!r || !r.length) continue;

    const typeVal = r[idx.type];
    if (!typeVal) continue;

    const safeNum = (arr, index) => {
      if (index === -1) return 0;
      const v = arr[index];
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    };

    items.push({
      type:           String(typeVal).trim(),
      in_repair:      safeNum(r, idx.r),
      in_transit:     safeNum(r, idx.t),
      await_reg:      safeNum(r, idx.reg),
      await_dispatch: safeNum(r, idx.disp),
      total:          safeNum(r, idx.total),
    });
  }

  return { items, date: maxDate };
}



// ==========================
// —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—Å—Ä–æ—á–∫–∏ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º
// ==========================
function computeTotalsFromAggRows(rows) {
  if (!rows || rows.length < 2) {
    return { total: 0, overdue: 0 };
  }

  const header = rows[0];
  const idxAsOf   = header.indexOf('as_of_date');
  const idxTotal  = header.indexOf('total_balance');
  const idxOver   = header.indexOf('overdue_balance');
  if (idxTotal === -1 || idxOver === -1) {
    console.warn('–ö–æ–ª–æ–Ω–∫–∏ total_balance / overdue_balance –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ ar_agg_client_contract');
    return { total: 0, overdue: 0 };
  }

  // 1) –Ω–∞–π–¥—ë–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É
  let maxDate = null;
  if (idxAsOf !== -1) {
    for (let i = 1; i < rows.length; i++) {
      const d = parseDate(rows[i][idxAsOf]);
      if (d && (!maxDate || d > maxDate)) maxDate = d;
    }
  }

  // 2) —Å—É–º–º–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–∏ –∑–∞ maxDate (–∏–ª–∏ –≤—Å–µ, –µ—Å–ª–∏ –¥–∞—Ç—ã –Ω–µ—Ç)
  const key = maxDate ? startOfDay(maxDate).getTime() : null;
  let total = 0, overdue = 0;

  for (let i = 1; i < rows.length; i++) {
    if (key) {
      const d = parseDate(rows[i][idxAsOf]);
      if (!d || startOfDay(d).getTime() !== key) continue;
    }
    total   += toNumber(rows[i][idxTotal]);
    overdue += toNumber(rows[i][idxOver]);
  }
  return { total, overdue };
}

// –î–∞—Ç–∞ —Å—Ä–µ–∑–∞ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π as_of_date –∏–∑ ar_agg_client_contract)
function getSnapshotDateFromAggRows(rows) {
    if (!rows || rows.length < 2) return null;

    const header = rows[0];
    const idxAsOf = header.indexOf('as_of_date');
    if (idxAsOf === -1) {
        console.warn('–ö–æ–ª–æ–Ω–∫–∞ as_of_date –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ ar_agg_client_contract');
        return null;
    }

    let maxDate = null;

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (!row || !row.length) continue;

        const raw = row[idxAsOf];
        if (!raw) continue;

        const d = parseDate(raw); // parseDate —É–∂–µ –µ—Å—Ç—å –≤—ã—à–µ –≤ –∫–æ–¥–µ
        if (!d) continue;

        if (!maxDate || d > maxDate) {
            maxDate = d;
        }
    }

    return maxDate;
}

// –§–æ—Ä–º–∞—Ç –≤–∏–¥–∞ "18 –Ω–æ—è–±—Ä—è"
function formatDateRuShort(date) {
    if (!date) return '';
    const months = [
        '—è–Ω–≤–∞—Ä—è','—Ñ–µ–≤—Ä–∞–ª—è','–º–∞—Ä—Ç–∞','–∞–ø—Ä–µ–ª—è','–º–∞—è','–∏—é–Ω—è',
        '–∏—é–ª—è','–∞–≤–≥—É—Å—Ç–∞','—Å–µ–Ω—Ç—è–±—Ä—è','–æ–∫—Ç—è–±—Ä—è','–Ω–æ—è–±—Ä—è','–¥–µ–∫–∞–±—Ä—è'
    ];
    const day = date.getDate();
    const monthName = months[date.getMonth()];
    return day + ' ' + monthName;
}
function buildPayablesFromRows(rows) {
  // –æ–∂–∏–¥–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏:
  // as_of_date, supplier_name, total_balance, overdue_balance, avg_days_overdue / avg_days_overd
  if (!rows || rows.length < 2) {
    return { date: null, total: 0, overdue: 0, suppliers: [] };
  }

  const header = rows[0];

  const idxAsOf = header.indexOf('as_of_date');
  const idxSupp =
    header.indexOf('supplier_name') !== -1
      ? header.indexOf('supplier_name')
      : header.indexOf('supplier');

  const idxTotal = header.indexOf('total_balance');
  let idxOver = header.indexOf('overdue_balance');
  if (idxOver === -1) idxOver = header.indexOf('overdue_balanc'); // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π

let idxMax = header.indexOf('max_days_overdue');
if (idxMax === -1) idxMax = header.indexOf('max_days_overd');

let idxAvg = header.indexOf('avg_days_overdue');
if (idxAvg === -1) idxAvg = header.indexOf('avg_days_overd');

// –∫–æ–ª–æ–Ω–∫–∞ —Å —Å—É–º–º–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –æ—Ç—Å—Ä–æ—á–∫–æ–π
let idxMaxDoc = header.indexOf('max_doc_balance');
if (idxMaxDoc === -1) idxMaxDoc = header.indexOf('max_doc_balanc');

// –∫–∞–∫—É—é –∫–æ–ª–æ–Ω–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç—Å—Ä–æ—á–∫–∏
const idxDelay = idxMax !== -1 ? idxMax : idxAvg;

  if (idxSupp === -1 || idxTotal === -1) {
    console.warn('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω—É–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ ap_suppliers');
    return { date: null, total: 0, overdue: 0, suppliers: [] };
  }

  let maxDate = null;
  const rowsNorm = [];

  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];
    if (!r || !r.length) continue;

    const supplier = r[idxSupp];
    if (!supplier) continue;

    let asOf = null;
    if (idxAsOf !== -1 && r[idxAsOf]) {
      asOf = parseDate(r[idxAsOf]);
      if (asOf && (!maxDate || asOf > maxDate)) {
        maxDate = asOf;
      }
    }

    rowsNorm.push({
      asOf,
      supplier: supplier,
      total: toNumber(r[idxTotal]),
      overdue: idxOver !== -1 ? toNumber(r[idxOver]) : 0,
      avg_overdue: idxDelay !== -1 ? toNumber(r[idxDelay]) : 0,
      max_doc_balance: idxMaxDoc !== -1 ? toNumber(r[idxMaxDoc]) : 0,
    });
  }

  if (!rowsNorm.length) {
    return { date: maxDate, total: 0, overdue: 0, suppliers: [] };
  }

  // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –¥–∞—Ç—ã
  let filtered = rowsNorm;
  if (maxDate) {
    const key = startOfDay(maxDate).getTime();
    filtered = rowsNorm.filter(
      (r) => r.asOf && startOfDay(r.asOf).getTime() === key
    );
  }

  let total = 0;
  let overdue = 0;
  const suppliers = [];

  for (const r of filtered) {
    total += r.total;
    overdue += r.overdue;

    // –≤ —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏ —Å –¥–æ–ª–≥–æ–º > 1 –º–ª–Ω
       if (r.total > 1_000_000) {
      suppliers.push({
        supplier: r.supplier,
        total: r.total,
        avg_overdue: r.avg_overdue,
        max_doc_balance: r.max_doc_balance,
      });
    }
  }

  suppliers.sort((a, b) => b.total - a.total);

  return { date: maxDate, total, overdue, suppliers };
}
function buildYesterdayLoadingFromRows(rows) {
    if (!rows || rows.length < 2) return { date: null, items: [] };

    const header = rows[0];
    const idxDate    = header.indexOf('op_date');
    const idxStation = header.indexOf('station_from');
    const idxStatus  = header.indexOf('status');

    if (idxDate === -1 || idxStation === -1) {
        console.warn('–ñ—É—Ä–Ω–∞–ª –ø–æ–≥—Ä—É–∑–∫–∏: –Ω–µ—Ç –∫–æ–ª–æ–Ω–æ–∫ op_date / station_from');
        return { date: null, items: [] };
    }

    const today = startOfDay(new Date());
    const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);
    const keyYest = yesterday.getTime();

    const byStation = new Map();

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (!row || !row.length) continue;

        const d = parseDate(row[idxDate]);
        if (!d || startOfDay(d).getTime() !== keyYest) continue;

        if (idxStatus !== -1) {
            const status = String(row[idxStatus] || '').toLowerCase();
            // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–æ–≥—Ä—É–∑–∫–∏
            if (status && status !== 'loaded') continue;
        }

        const st = row[idxStation];
        if (!st) continue;

        const key = String(st).trim();
        byStation.set(key, (byStation.get(key) || 0) + 1);
    }

    const items = Array.from(byStation.entries())
        .map(([station, count]) => ({ station, count }))
        // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é, –∫–∞–∫ –ø—Ä–æ—Å–∏–ª: "–ö—Ä–∞—Å–Ω—ã–π –ì—É–ª—è–π ‚Äî 50" –∏ —Ç.–¥.
        .sort((a, b) => b.count - a.count || a.station.localeCompare(b.station, 'ru'));

    return { date: yesterday, items };
}
    
function buildReceivablesByClientFromRows(rows) {
    if (!rows || !rows.length) return [];

    const header = rows[0];
    const idxAsOf    = header.indexOf('as_of_date');
    const idxClient  = header.indexOf('client_name');
    const idxOverdue = header.indexOf('overdue_balance');

    if (idxClient === -1 || idxOverdue === -1) {
        console.warn('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –∫–æ–ª–æ–Ω–∫–∏ client_name / overdue_balance –≤ ar_agg_client_contract');
        return [];
    }

    const items = [];
    let maxDate = null;

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (!row || !row.length) continue;

        const client = row[idxClient];
        if (!client) continue;

        const overdueVal = toNumber(row[idxOverdue]);
        if (!overdueVal) continue; // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤ –±–µ–∑ –ø—Ä–æ—Å—Ä–æ—á–∫–∏

        let asOfDate = null;
        if (idxAsOf !== -1) {
            const asOfRaw = row[idxAsOf];
            if (asOfRaw) {
                asOfDate = parseDate(asOfRaw);
            }
        }

        if (asOfDate && (!maxDate || asOfDate > maxDate)) {
            maxDate = asOfDate;
        }

        items.push({
            client: client,
            overdue: overdueVal,
            asOf: asOfDate
        });
    }

    if (!items.length) return [];

    // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–∞—Ç—É
    let filtered = items;
    if (maxDate) {
        const maxKey = startOfDay(maxDate).getTime();
        filtered = items.filter(it =>
            it.asOf && startOfDay(it.asOf).getTime() === maxKey
        );
    }

    // –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –ø–æ –∫–ª–∏–µ–Ω—Ç—É
    const sums = new Map();
    for (const it of filtered) {
        const key = String(it.client).trim();
        const prev = sums.get(key) || 0;
        sums.set(key, prev + it.overdue);
    }

    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ > 1 000 000 ‚ÇΩ
    const result = Array.from(sums.entries())
        .map(([client, overdue]) => ({ client, overdue }))
        .filter(r => r.overdue > 1000000)          // üëà —Ç–æ–ª—å–∫–æ –∫–æ–º–ø–∞–Ω–∏–∏ —Å –ø—Ä–æ—Å—Ä–æ—á–∫–æ–π > 1 –º–ª–Ω
        .sort((a, b) => b.overdue - a.overdue);

    return result;
}


// ==========================
// 3. –°–ë–û–†–ö–ê dashboardData
// ==========================

function buildDashboardDataFromRaw(rowObjs, monthPlanTotal) {
    monthPlanTotal = monthPlanTotal || 0;
    if (!rowObjs.length) {
        return {
            loading: {
                loaded_wagons_month: 0,
                planned_wagons_today: 0,
                loaded_wagons_yesterday: 0,
                plan_month: 0,
                month_total_plan: monthPlanTotal,
                progress_percent: 0
            },
            receivables: {
                total_debt: 0,
                overdue_debt: 0,
                overdue_percent: 0
            },
            repairs: {
                tr_count: 0,
                kr_count: 0,
                tor_count: 0,
                fleet_total: 0,
                tr_percent: 0,
                kr_percent: 0,
                tor_percent: 0
            },
            daily_trend: [],
            last_update: '',
            period_label: ''
        };
    }

    const today = startOfDay(new Date());
    const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);
    
    const rowYesterday = rowObjs.find(r => startOfDay(r.date).getTime() === yesterday.getTime());
    const loadedYesterday = rowYesterday ? rowYesterday.loaded_wagons : 0;

    const rowToday = rowObjs.find(r => startOfDay(r.date).getTime() === today.getTime());
    const plannedToday = rowToday ? rowToday.planned_wagons : 0;

    // —Å–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ –¥–∞—Ç–µ –∏ –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω—é—é
    const sorted = rowObjs.slice().sort((a, b) => a.date - b.date);
    const lastRow = sorted[sorted.length - 1];
const lastDate = startOfDay(lastRow.date);
const monthStart = new Date(lastDate.getFullYear(), lastDate.getMonth(), 1);
const monthEnd = lastDate;

const rowsThisMonth = rowObjs.filter(r => {
    const d = startOfDay(r.date);
    return d >= monthStart && d <= monthEnd;
});

const loadedMonth = rowsThisMonth.reduce((sum, r) => sum + (r.loaded_wagons || 0), 0);
const planMonth   = rowsThisMonth.reduce((sum, r) => sum + (r.planned_wagons || 0), 0);

    // === –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –î–õ–Ø –ó–ê–î–û–õ–ñ–ï–ù–ù–û–°–¢–ò ===
    // 1) –µ—Å–ª–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –µ—Å—Ç—å –Ω–µ–Ω—É–ª–µ–≤–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å ‚Äî –±–µ—Ä—ë–º –µ—ë
    // 2) –∏–Ω–∞—á–µ –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É –¥–æ —Å–µ–≥–æ–¥–Ω—è —Å –Ω–µ–Ω—É–ª–µ–≤–æ–π –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å—é
    // 3) –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º lastRow (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
    const hasTodayDebt =
        rowToday &&
        (
            (rowToday.total_debt  || 0) !== 0 ||
            (rowToday.overdue_debt || 0) !== 0
        );

    let debtRow;
    if (hasTodayDebt) {
        debtRow = rowToday;
    } else {
        const reversed = sorted.slice().reverse();
        debtRow = reversed.find(r => {
            const d = startOfDay(r.date);
            if (d.getTime() >= today.getTime()) return false; // —Ç–æ–ª—å–∫–æ –¥–Ω–∏ < —Å–µ–≥–æ–¥–Ω—è
            const td = r.total_debt || 0;
            const od = r.overdue_debt || 0;
            return td !== 0 || od !== 0;
        }) || lastRow;
    }

    // –ø–µ—Ä–∏–æ–¥: —Å 1-–≥–æ —á–∏—Å–ª–∞ –º–µ—Å—è—Ü–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏ –ø–æ –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏
    const periodStart = new Date(lastRow.date.getFullYear(), lastRow.date.getMonth(), 1);
    const periodLabel =
        `–ü–æ–≥—Ä—É–∑–∫–∞ —Å ${formatDateDMY(periodStart)} –ø–æ ${formatDateDMY(lastRow.date)}`;

    // —Å—á–∏—Ç–∞–µ–º –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π debtRow
    const totalDebt = (debtRow && debtRow.total_debt) || 0;
    const overdueDebt = (debtRow && debtRow.overdue_debt) || 0;
    const overduePercent = totalDebt ? Math.round(overdueDebt / totalDebt * 100) : 0;

    const fleetTotal = lastRow.fleet_total || 2000;

    const tr = lastRow.tr_count || 0;
    const kr = lastRow.kr_count || 0;
    const tor = lastRow.tor_count || 0;

    const trPercent  = fleetTotal ? Math.round(tr  / fleetTotal * 100) : 0;
    const krPercent  = fleetTotal ? Math.round(kr  / fleetTotal * 100) : 0;
    const torPercent = fleetTotal ? Math.round(tor / fleetTotal * 100) : 0;

    const last7 = sorted.slice(-7);
    const dailyTrend = last7.map(r => {
        const d = r.date;
        const dd = String(d.getDate()).padStart(2, '0');
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        return { label: `${dd}.${mm}`, wagons: r.loaded_wagons };
    });

    return {
        loading: {
            loaded_wagons_month: loadedMonth,
            planned_wagons_today: plannedToday,
            loaded_wagons_yesterday: loadedYesterday,
            plan_month: planMonth,                // ¬´–ü–æ –ø–ª–∞–Ω—É¬ª (–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞–Ω)
            month_total_plan: monthPlanTotal,     // –ü–ª–∞–Ω –Ω–∞ –º–µ—Å—è—Ü (–∏–∑ L1)
            progress_percent: planMonth ? Math.round(loadedMonth / planMonth * 100) : 0
        },

        receivables: {
            total_debt: totalDebt,
            overdue_debt: overdueDebt,
            overdue_percent: overduePercent
        },
        repairs: {
            tr_count: tr,
            kr_count: kr,
            tor_count: tor,
            fleet_total: fleetTotal,
            tr_percent: trPercent,
            kr_percent: krPercent,
            tor_percent: torPercent
        },
        daily_trend: dailyTrend,
        last_update: lastRow.timestamp,
        period_label: periodLabel
    };
}



async function loadDataFromSheet() {
  let snapshotDate = null; // –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∏ –¥–ª—è —Ä–µ–º–æ–Ω—Ç–æ–≤
  // 1) –æ—Å–Ω–æ–≤–Ω–æ–π raw_data
  const res = await fetch(SHEET_CSV_URL);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const csvText = await res.text();
    const rows = parseCSV(csvText);
   
    // –ò—â–µ–º –ø–ª–∞–Ω –Ω–∞ –º–µ—Å—è—Ü –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ (–∫–∞–∫ –±—ã–ª–æ)
    let monthPlanFromHeader = 0;
    if (rows.length) {
        const headerRow = rows[0];
        for (let i = headerRow.length - 1; i >= 0; i--) {
            const cell = headerRow[i];
            if (cell !== '') {
                monthPlanFromHeader = toNumber(cell);
                break;
            }
        }
    }

    const rowObjs = rowsToObjects(rows);
    dashboardData = buildDashboardDataFromRaw(rowObjs, monthPlanFromHeader);
        // 3) ar_payments_daily
    if (SHEET_PAYMENTS_CSV_URL) {
        try {
            const resPay = await fetch(SHEET_PAYMENTS_CSV_URL);
            if (resPay.ok) {
                const csvTextPay = await resPay.text();
                const rowsPay = parseCSV(csvTextPay);

                const payments = buildPaymentsFromRows(rowsPay);
                paymentsLastDate = payments.lastDate;
                paymentsByClient = payments.items;
            } else {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å ar_payments_daily, —Å—Ç–∞—Ç—É—Å:', resPay.status);
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ar_payments_daily:', e);
        }
    }
    // 2) —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—Å—Ä–æ—á–∫–∏ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º + —Å—É–º–º—ã –∏–∑ ar_agg_client_contract
    receivablesByClient = [];

    if (SHEET_CLIENTS_CSV_URL) {
        try {
            const resClients = await fetch(SHEET_CLIENTS_CSV_URL);
            if (resClients.ok) {
                const csvTextClients = await resClients.text();
                const rowsClients = parseCSV(csvTextClients);
                // –¥–∞—Ç–∞ —Å—Ä–µ–∑–∞ (–∞–Ω–∞–ª–æ–≥ G1 –Ω–∞ –ª–∏—Å—Ç–µ ar_agg_client_contract)
                  snapshotDate = getSnapshotDateFromAggRows(rowsClients);
                if (snapshotDate && dashboardData) {
                    dashboardData.receivables_date = snapshotDate;
                }

                // –∞) —Å—á–∏—Ç–∞–µ–º –æ–±—â—É—é –∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—É—é –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å –ø–æ agg-–ª–∏—Å—Ç—É
                const aggTotals = computeTotalsFromAggRows(rowsClients);
                    if (dashboardData && dashboardData.receivables) {
                        dashboardData.receivables.total_debt   = aggTotals.total;
                        dashboardData.receivables.overdue_debt = aggTotals.overdue;
                        dashboardData.receivables.overdue_percent =
                            aggTotals.total
                                ? Math.round(aggTotals.overdue / aggTotals.total * 100)
                                : 0;
                    }

                // –±) —Å—Ç—Ä–æ–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º (–¢–û–ü > 1 –º–ª–Ω)
                receivablesByClient = buildReceivablesByClientFromRows(rowsClients);
            } else {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å ar_agg_client_contract, —Å—Ç–∞—Ç—É—Å:', resClients.status);
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–æ–¥–∫–∏ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º:', e);
        }
    }
        // 3) –ö—Ä–µ–¥–∏—Ç–æ—Ä–∫–∞: ap_suppliers
    if (SHEET_AP_SUPPLIERS_CSV_URL) {
      try {
        const resAp = await fetch(SHEET_AP_SUPPLIERS_CSV_URL);
        if (resAp.ok) {
          const csvAp = await resAp.text();
          const rowsAp = parseCSV(csvAp);
          const ap = buildPayablesFromRows(rowsAp);

          if (!dashboardData.payables) {
            dashboardData.payables = {};
          }

          dashboardData.payables.total_debt = ap.total;
          dashboardData.payables.overdue_debt = ap.overdue;
          dashboardData.payables.overdue_percent =
            ap.total ? Math.round((ap.overdue / ap.total) * 100) : 0;
          dashboardData.payables_date = ap.date;

          payablesBySupplier = ap.suppliers;
        } else {
          console.warn(
            '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å ap_suppliers, —Å—Ç–∞—Ç—É—Å:',
            resAp.status
          );
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ap_suppliers:', e);
      }
    }
    // 4) –ñ—É—Ä–Ω–∞–ª –ø–æ–≥—Ä—É–∑–∫–∏: —Ä–∞–∑–±–∏–≤–∫–∞ "–≤—á–µ—Ä–∞ –ø–æ–≥—Ä—É–∂–µ–Ω–æ" –ø–æ —Å—Ç–∞–Ω—Ü–∏—è–º
    yesterdayLoadingStations = [];
    yesterdayLoadingDate = null;

    if (SHEET_LOADING_JOURNAL_CSV_URL) {
        try {
            const resLog = await fetch(SHEET_LOADING_JOURNAL_CSV_URL);
            if (resLog.ok) {
                const csvLog = await resLog.text();
                const rowsLog = parseCSV(csvLog);
                const result = buildYesterdayLoadingFromRows(rowsLog);
                yesterdayLoadingDate = result.date;
                yesterdayLoadingStations = result.items;
            } else {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∂—É—Ä–Ω–∞–ª –ø–æ–≥—Ä—É–∑–∫–∏, —Å—Ç–∞—Ç—É—Å:', resLog.status);
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂—É—Ä–Ω–∞–ª–∞ –ø–æ–≥—Ä—É–∑–∫–∏:', e);
        }
    }
// 5) –û—Å—Ç–∞—Ç–∫–∏ –¥–µ–Ω–µ–∂–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤
if (SHEET_CASH_CSV_URL) {
  try {
    const resCash = await fetch(SHEET_CASH_CSV_URL);
    if (resCash.ok) {
      const csvCash = await resCash.text();
      const rowsCash = parseCSV(csvCash);
      const cash = buildCashFromRows(rowsCash);
      if (cash) {
        if (!dashboardData) dashboardData = {};
        dashboardData.cash = cash;
      }
    } else {
      console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å cash_balances, —Å—Ç–∞—Ç—É—Å:', resCash.status);
    }
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ cash_balances:', e);
  }
}

// 6) budget_production (–±—é–¥–∂–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–π —Å–ª—É–∂–±—ã)
budgetProduction = null;
budgetCommercial = null; // üëà –æ–±–Ω—É–ª—è–µ–º –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –±—é–¥–∂–µ—Ç –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π

if (typeof SHEET_BUDGET_PROD_CSV_URL !== 'undefined' && SHEET_BUDGET_PROD_CSV_URL) {
  try {
    const resBudget = await fetch(SHEET_BUDGET_PROD_CSV_URL);
    if (resBudget.ok) {
      const csvBudget = await resBudget.text();
      const rowsBudget = parseCSV(csvBudget);
      budgetProduction = buildBudgetProductionFromRows(rowsBudget);
    } else {
      console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å budget_production, —Å—Ç–∞—Ç—É—Å:', resBudget.status);
    }
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ budget_production:', e);
  }
}

// 7) budget_commercial (–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è —Å–ª—É–∂–±–∞: KPI + –Ω–∞—Ç—É—Ä–∫–∞)
if (typeof SHEET_COMM_KPI_CSV_URL !== 'undefined' && SHEET_COMM_KPI_CSV_URL) {
  try {
    const resKpi = await fetch(SHEET_COMM_KPI_CSV_URL);
    if (resKpi.ok) {
      const csvKpi = await resKpi.text();
      const kpiRows = parseCSV(csvKpi);

      let natRows = null;
      if (typeof SHEET_COMM_NAT_CSV_URL !== 'undefined' && SHEET_COMM_NAT_CSV_URL) {
        try {
          const resNat = await fetch(SHEET_COMM_NAT_CSV_URL);
          if (resNat.ok) {
            const csvNat = await resNat.text();
            natRows = parseCSV(csvNat);
          } else {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å comm_nat, —Å—Ç–∞—Ç—É—Å:', resNat.status);
          }
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ comm_nat:', e);
        }
      }

      budgetCommercial = buildBudgetCommercialFromRows(kpiRows, natRows);
    } else {
      console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å comm_kpi, —Å—Ç–∞—Ç—É—Å:', resKpi.status);
    }
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ comm_kpi / comm_nat:', e);
  }
}

// 8) repairs_snapshot (–ø–æ—Å–ª–µ–¥–Ω–∏–º, –∫–æ–≥–¥–∞ —É–∂–µ –µ—Å—Ç—å snapshotDate)
try {
  const repairsCsv = await fetch(SHEET_REPAIRS_CSV_URL).then(r => r.text());
  const repRows = parseCSV(repairsCsv);

  const repairsData = buildRepairsFromSnapshot(repRows);
  const repairsDate = repairsData.date || snapshotDate || null;

  renderRepairsCard(repairsData.items, repairsDate);
} catch (e) {
  console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ repairs_snapshot:', e);
  renderRepairsCard([], snapshotDate);
}


}

// ==========================
// 4. –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï / –í–†–ï–ú–Ø
// ==========================

function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
}

function formatCurrency(amount) {
    const millions = (amount / 1000000).toFixed(1);
    return `${millions} –º–ª–Ω. —Ä.`;
}
function formatMillions(amount) {
  const millions = (amount / 1_000_000).toFixed(1); // —Ç—É—Ç –æ—Å—Ç–∞—ë—Ç—Å—è –≤ –º–ª–Ω
  return millions;
}

// —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É–º–º—ã –≤ —Ä—É–±–ª—è—Ö (–±–µ–∑ –¥–µ–ª–µ–Ω–∏—è –Ω–∞ 1000)
function formatThousands(amount) {
  if (amount === null || amount === undefined || isNaN(amount)) return '0';
  const rounded = Math.round(amount);      // –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ —Ä—É–±–ª—è
  return formatNumber(rounded);            // 2 442, 2 150 –∏ —Ç.–ø.
}

function updateDateTime() {
    const now = new Date();
    const options = {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    };
    document.getElementById('currentDateTime').textContent =
        now.toLocaleDateString('ru-RU', options);
}
    
function formatUpdatedAt(date) {
    const dd = String(date.getDate()).padStart(2, '0');
    const mm = String(date.getMonth() + 1).padStart(2, '0');
    const yyyy = date.getFullYear();
    const hh = String(date.getHours()).padStart(2, '0');
    const min = String(date.getMinutes()).padStart(2, '0');
    const ss = String(date.getSeconds()).padStart(2, '0');
    return `${dd}-${mm}-${yyyy} ${hh}:${min}:${ss}`;
}

// ==========================
// 5. –ó–ê–ü–û–õ–ù–ï–ù–ò–ï –ö–ê–†–¢–û–ß–ï–ö
// ==========================
    function renderYesterdayLoadingList() {
    const panel = document.getElementById('loadingYesterdayPanel');
    const listEl = document.getElementById('loadingYesterdayList');

    if (!panel || !listEl) return;

    listEl.innerHTML = '';

    if (!yesterdayLoadingStations || !yesterdayLoadingStations.length) {
        const li = document.createElement('li');
        li.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–æ–≥—Ä—É–∑–∫–µ –∑–∞ –≤—á–µ—Ä–∞.';
        li.style.fontSize = '12px';
        li.style.color = 'var(--text-secondary)';
        listEl.appendChild(li);
        return;
    }

    yesterdayLoadingStations.forEach(row => {
        const li = document.createElement('li');
        li.textContent = `${row.station} ‚Äî ${row.count}`;
        listEl.appendChild(li);
    });
}

function renderReceivablesByClient() {
    const panel = document.getElementById('clientsOverduePanel');
    const tbody = document.getElementById('clientsOverdueBody');
    const toggle = document.getElementById('toggleClientsOverdue');

    if (!panel || !tbody || !toggle) return;

    tbody.innerHTML = '';

    if (!receivablesByClient || !receivablesByClient.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 3;
        td.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–π –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏.';
        td.style.fontSize = '12px';
        td.style.color = 'var(--text-secondary)';
        tr.appendChild(td);
        tbody.appendChild(tr);
        toggle.disabled = true;
        return;
    }

    toggle.disabled = false;

    const totalOverdue = receivablesByClient.reduce((sum, r) => sum + r.overdue, 0);

    receivablesByClient.forEach(row => {
        const tr = document.createElement('tr');

        const tdClient = document.createElement('td');
        tdClient.textContent = row.client;
        tr.appendChild(tdClient);

        const tdAmount = document.createElement('td');
        tdAmount.className = 'amount';
        tdAmount.textContent = formatCurrency(row.overdue);
        tr.appendChild(tdAmount);

        const tdPerc = document.createElement('td');
        tdPerc.className = 'percent';
        const p = totalOverdue ? Math.round(row.overdue / totalOverdue * 100) : 0;
        tdPerc.textContent = p + '%';
        tr.appendChild(tdPerc);

        tbody.appendChild(tr);
    });
}
function renderPayablesSuppliers() {
  const panel = document.getElementById('suppliersPayablesPanel');
  const tbody = document.getElementById('suppliersPayablesBody');
  const toggle = document.getElementById('toggleSuppliersPayables');

  if (!panel || !tbody || !toggle) return;

  tbody.innerHTML = '';

  if (!payablesBySupplier || !payablesBySupplier.length) {
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 3;
    td.textContent =
      '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫—Ä–µ–¥–∏—Ç–æ—Ä—Å–∫–æ–π –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏ (–∏–ª–∏ –Ω–µ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ —Å –¥–æ–ª–≥–æ–º > 1 –º–ª–Ω).';
    td.style.fontSize = '12px';
    td.style.color = 'var(--text-secondary)';
    tr.appendChild(td);
    tbody.appendChild(tr);
    toggle.disabled = true;
    return;
  }

  toggle.disabled = false;

  payablesBySupplier.forEach((row) => {
    const tr = document.createElement('tr');

    const tdSupplier = document.createElement('td');
    tdSupplier.textContent = row.supplier;
    tr.appendChild(tdSupplier);

    const tdAmount = document.createElement('td');
    tdAmount.className = 'amount';
    tdAmount.textContent = formatCurrency(row.total);
    tr.appendChild(tdAmount);

    const tdAvg = document.createElement('td');
    tdAvg.className = 'percent';

    if (row.avg_overdue) {
      const days = Math.round(row.avg_overdue);
      let text = days + ' –¥.';
      if (row.max_doc_balance) {
        text += ' (' + formatMillions(row.max_doc_balance) + ' –º–ª–Ω)';
      }
      tdAvg.textContent = text;
    } else {
      tdAvg.textContent = '‚Äî';
    }

    tr.appendChild(tdAvg);

    tbody.appendChild(tr);
  });
}
    
function renderPaymentsCard() {
    const dateLabel = document.getElementById('paymentsDateLabel');
    const selectEl  = document.getElementById('paymentsCompanySelect');
    const amountEl  = document.getElementById('paymentsAmountValue');

    if (!dateLabel || !selectEl || !amountEl) return;

    // –ü–æ–¥–ø–∏—Å—å –¥–∞—Ç—ã
    if (paymentsLastDate) {
        dateLabel.textContent = '–î–∞–Ω–Ω—ã–µ –Ω–∞ ' + formatDateRuShort(paymentsLastDate);
    } else {
        dateLabel.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è—Ö';
    }

    // –ù–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π
    selectEl.innerHTML = '';

    if (!paymentsByClient || !paymentsByClient.length) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
        selectEl.appendChild(opt);
        amountEl.textContent = '0 ‚ÇΩ';
        return;
    }

    paymentsByClient.forEach((item, idx) => {
        const opt = document.createElement('option');
        opt.value = idx; // –∏–Ω–¥–µ–∫—Å –≤ –º–∞—Å—Å–∏–≤–µ
        opt.textContent = item.client;
        selectEl.appendChild(opt);
    });

    // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞
    selectEl.onchange = function() {
        const idx = Number(this.value);
        if (isNaN(idx) || !paymentsByClient[idx]) {
            amountEl.textContent = '0 ‚ÇΩ';
            return;
        }
        const amount = paymentsByClient[idx].amount || 0;
        amountEl.textContent = formatCurrency(amount);
    };

    // –≤—ã—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    selectEl.value = '0';
    const first = paymentsByClient[0];
    amountEl.textContent = formatCurrency(first.amount || 0);
}
function renderRepairsCard(items, dateStr) {
  // –ö–æ–¥—ã –∏–∑ —Ç–∞–±–ª–∏—Ü—ã: TOR, DR, KR, DRA, WASH
  const order = ['TOR', 'DR', 'KR', 'DRA', 'WASH'];
  const labels = {
    TOR: '–¢–û–†',
    DR:  '–î–†',
    KR:  '–ö–†',
    DRA: '–î–†–ê',
    WASH:'–ü—Ä–æ–º—ã–≤–∫–∞',
  };

  const list = document.getElementById('repairsTotalsList');
  if (!list) return;
  list.innerHTML = '';

  const normalized = {};
  let totalInRepairs = 0;

  (items || []).forEach(x => {
    if (!x || !x.type) return;
    const key = String(x.type).toUpperCase().trim(); // TOR/DR/...
    const total = Number(x.total) || 0;
    normalized[key] = Object.assign({}, x, { total });
    totalInRepairs += total;
  });

  // –¢–æ—Ç–∞–ª—ã –ø–æ –≤–∏–¥–∞–º —Ä–µ–º–æ–Ω—Ç–∞ (–≤–µ—Ä—Ö–Ω—è—è —Å—Ç—Ä–æ–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏)
  order.forEach(code => {
    const x = normalized[code] || { total: 0 };
    const row = document.createElement('div');
    row.className = 'repair-total-item';
    row.innerHTML = `
      <div class="repair-type-label">${labels[code] || code}</div>
      <div class="repair-type-value">${x.total || 0}</div>
    `;
    list.appendChild(row);
  });

  // –¢–∞–±–ª–∏—Ü–∞ –ø–æ —Å—Ç–∞–¥–∏—è–º
  const tbody = document.getElementById('repairsTableBody');
  if (tbody) {
    tbody.innerHTML = '';
    order.forEach(code => {
      const x = normalized[code] || {
        in_repair: 0,
        in_transit: 0,
        await_reg: 0,
        await_dispatch: 0,
        total: 0,
      };
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${labels[code] || code}</td>
        <td>${x.in_repair}</td>
        <td>${x.in_transit}</td>
        <td>${x.await_reg}</td>
        <td>${x.await_dispatch}</td>
        <td><b>${x.total}</b></td>
      `;
      tbody.appendChild(tr);
    });
  }

  // –ü–æ–¥–ø–∏—Å—å "–î–∞–Ω–Ω—ã–µ –Ω–∞ ..." –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
  const dateEl = document.getElementById('repairsDate');
  if (dateEl) {
    dateEl.textContent = dateStr ? ('–î–∞–Ω–Ω—ã–µ –Ω–∞ ' + formatDateRuShort(dateStr)) : '';
  }

  // –ò—Ç–æ–≥ –ø–æ —Ä–µ–º–æ–Ω—Ç–∞–º –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ: (N; X%)
  const headerSummaryEl = document.getElementById('repairsHeaderSummary');
  if (headerSummaryEl) {
    const fleetTotal =
      dashboardData &&
      dashboardData.repairs &&
      dashboardData.repairs.fleet_total
        ? dashboardData.repairs.fleet_total
        : 0;

        const percent = fleetTotal ? Math.round((totalInRepairs / fleetTotal) * 100) : 0;

    if (totalInRepairs > 0) {
      const totalFormatted = formatNumber(totalInRepairs);
      if (percent > 0) {
        headerSummaryEl.innerHTML =
          `${totalFormatted}<div class="metric-label">(${percent}% –æ—Ç –æ–±—â–µ–≥–æ –ø–∞—Ä–∫–∞)</div>`;
      } else {
        headerSummaryEl.textContent = `${totalFormatted}`;
      }
    } else {
      headerSummaryEl.textContent = '';
    }

  }
}
function renderBudgetProductionCard() {
  const card = document.getElementById('budget-card');
  if (!card) return;
  if (!budgetProduction) return;

  const period = budgetProduction.period || {};
  const monthsNames = [
  '—è–Ω–≤–∞—Ä—å','—Ñ–µ–≤—Ä–∞–ª—å','–º–∞—Ä—Ç','–∞–ø—Ä–µ–ª—å','–º–∞–π','–∏—é–Ω—å',
  '–∏—é–ª—å','–∞–≤–≥—É—Å—Ç','—Å–µ–Ω—Ç—è–±—Ä—å','–æ–∫—Ç—è–±—Ä—å','–Ω–æ—è–±—Ä—å','–¥–µ–∫–∞–±—Ä—å'
];

  // –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ "–ë—é–¥–∂–µ—Ç 2025 –≥., 10 –º–µ—Å. (–ø–æ –æ–∫—Ç—è–±—Ä—é)"
  const subtitleEl = document.getElementById('budgetSubtitle');
  if (subtitleEl) {
    const m = period.month;
    const y = period.year;
    const monthsTotal = period.monthsTotal || m;
    let text = '';

    if (y && monthsTotal && m) {
      const mName = monthsNames[m - 1] || '';
      text = `–ë—é–¥–∂–µ—Ç ${y} –≥., ${monthsTotal} –º–µ—Å. (–ø–æ ${mName})`;
    } else if (y && monthsTotal) {
      text = `–ë—é–¥–∂–µ—Ç ${y} –≥., ${monthsTotal} –º–µ—Å.`;
    } else if (y) {
      text = `–ë—é–¥–∂–µ—Ç ${y} –≥.`;
    }

    subtitleEl.textContent = text;
  }

  // "10 –º–µ—Å—è—Ü–µ–≤" —Å–ø—Ä–∞–≤–∞ –æ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
  const monthsLabel = (period.monthsTotal || period.month)
    ? `${period.monthsTotal || period.month} –º–µ—Å—è—Ü–µ–≤`
    : '‚Äî';

  const monthsEl = document.getElementById('budgetProdMonths');
  if (monthsEl) monthsEl.textContent = monthsLabel;

    // –ò—Ç–æ–≥–∏ –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º –∏ —Ç–∞—Ä–∏—Ñ—É (—à–∞–ø–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏)
  const expSummaryEl = document.getElementById('budgetProdExpSummary');
  if (expSummaryEl && budgetProduction.expSummary) {
    const s = budgetProduction.expSummary;
    const factBad = s.plan != null && s.fact != null && s.fact > s.plan;
    expSummaryEl.innerHTML =
      `${formatMillions(s.plan)} / ` +
      `<span class="${factBad ? 'text-negative' : ''}">${formatMillions(s.fact)}</span> –º–ª–Ω. —Ä.`;
  }

  const revSummaryEl = document.getElementById('budgetProdRevSummary');
  if (revSummaryEl && budgetProduction.revSummary) {
    const s = budgetProduction.revSummary;
    const factBad = s.plan != null && s.fact != null && s.fact > s.plan;
    revSummaryEl.innerHTML =
      `${formatMillions(s.plan)} / ` +
      `<span class="${factBad ? 'text-negative' : ''}">${formatMillions(s.fact)}</span> –º–ª–Ω. —Ä.`;
  }

  // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–û–†–ú–ê–¢–¢–ï–†–´ ---
  function formatCellMillions(value) {
    if (value === null || value === undefined || value === 0) return '‚Äî';
    return formatMillions(value) + ' –º–ª–Ω. —Ä.';
  }

function formatCellThousands(value) {
  if (value === null || value === undefined || value === 0) return '‚Äî';
  return formatThousands(value) + ' —Ä—É–±.';
}

  const formatQty = (value) => {
    if (value === null || value === undefined || value === 0) return '‚Äî';
    return formatNumber(Math.round(value));
  };

  // --- –õ–µ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞: –†–∞—Å—Ö–æ–¥—ã (—à—Ç + –¥–µ–Ω—å–≥–∏) ---
  const expBody = document.getElementById('budgetProdExpBody');
  if (expBody) {
    expBody.innerHTML = '';

    const makeRow = (name, qtyPlan, qtyFact, plan, fact, extraClass) => {
      const tr = document.createElement('tr');
      if (extraClass) tr.classList.add(extraClass);

      if (extraClass === 'group-row') {
        const td = document.createElement('td');
        td.colSpan = 5;
        td.textContent = name;
        tr.appendChild(td);
      } else {
        const tdName = document.createElement('td');
        tdName.textContent = name;
        tr.appendChild(tdName);

        const tdQtyPlan = document.createElement('td');
        tdQtyPlan.className = 'amount';
        tdQtyPlan.textContent = formatQty(qtyPlan);
        tr.appendChild(tdQtyPlan);

        const tdQtyFact = document.createElement('td');
        tdQtyFact.className = 'amount';
        tdQtyFact.textContent = formatQty(qtyFact);
        tr.appendChild(tdQtyFact);

        const tdPlan = document.createElement('td');
        tdPlan.className = 'amount';
        tdPlan.textContent = formatCellMillions(plan);
        tr.appendChild(tdPlan);

        const tdFact = document.createElement('td');
        tdFact.className = 'amount';
        tdFact.textContent = formatCellMillions(fact);

        if (plan != null && fact != null && fact > plan) {
          tdFact.classList.add('text-negative');
        }

        tr.appendChild(tdFact);
      }

      expBody.appendChild(tr);
    };

    const mainRows  = budgetProduction.expensesMain  || [];
    const otherRows = budgetProduction.expensesOther || [];
    const totalRows = budgetProduction.expensesTotal || [];

    // –û—Å–Ω–æ–≤–Ω—ã–µ (–î–†, –ö–†, –¢–û–†, –ó.–ß.)
    mainRows.forEach(r =>
      makeRow(r.name, r.qtyPlan, r.qtyFact, r.plan, r.fact)
    );

    // –ü—Ä–æ—á–∏–µ (—Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ, —Å–ª–µ–∂–µ–Ω–∏–µ, –ü/–ü, –∞—Ä–µ–Ω–¥–∞ –∏ —Ç.–ø.) ‚Äî –±–µ–∑ —Å—Ç—Ä–æ–∫–∏ "–ü–µ—Ä–µ—Ö–æ–¥—è—â–∏–µ"
    otherRows.forEach(r =>
      makeRow(r.name, r.qtyPlan, r.qtyFact, r.plan, r.fact)
    );

    // –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ "–í—Å–µ–≥–æ" ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
    if (totalRows.length) {
      const t = totalRows[0];
      makeRow(
        t.name || '–í—Å–µ–≥–æ',
        null,
        null,
        t.plan,
        t.fact,
        'total-row'
      );
    }
  }

  // --- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è ¬´–ø—Ä–æ—Å—Ç—ã—Ö¬ª —Ç–∞–±–ª–∏—Ü (—Å—Ä–µ–¥–Ω–∏–µ + —Ç–∞—Ä–∏—Ñ) ---
  function fillSimpleTable(tbodyId, rows) {
    const tbody = document.getElementById(tbodyId);
    if (!tbody) return;

    tbody.innerHTML = '';

    // –î–ª—è —Å—Ä–µ–¥–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É–±–ª—è—Ö.
    const useThousands =
      tbodyId === 'budgetProdExpAvgBody' ||
      tbodyId === 'budgetProdRevAvgBody';

    const formatFn = useThousands ? formatCellThousands : formatCellMillions;

    (rows || []).forEach(r => {
      const tr = document.createElement('tr');

      const tdName = document.createElement('td');
      tdName.textContent = r.name;
      tr.appendChild(tdName);

      const tdPlan = document.createElement('td');
      tdPlan.className = 'amount';
      tdPlan.textContent = formatFn(r.plan);
      tr.appendChild(tdPlan);

      const tdFact = document.createElement('td');
      tdFact.className = 'amount';
      tdFact.textContent = formatFn(r.fact);

      if (r.plan != null && r.fact != null && r.fact > r.plan) {
        tdFact.classList.add('text-negative');
      }

      tr.appendChild(tdFact);

      tbody.appendChild(tr);
    });
  }

  // –°—Ä–µ–¥–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥—ã (—Ä–µ–º–æ–Ω—Ç)
  fillSimpleTable('budgetProdExpAvgBody', budgetProduction.expensesAvg || []);

  // –¢–∞—Ä–∏—Ñ –ø–æ —Å—Ç–∞—Ç—å—è–º
  fillSimpleTable('budgetProdRevBody', budgetProduction.revenue || []);

  // –°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (—Ç–∞—Ä–∏—Ñ) ‚Äî –±–µ–∑ —Å—Ç—Ä–æ–∫–∏ "–ö–æ–ª. –≤–∞–≥–æ–Ω–æ–≤ (—Å—Ä–µ–¥–Ω–µ–µ)"
  const revenueAvgFiltered = (budgetProduction.revenueAvg || []).filter(
    r => r.code !== 'WAGONS_AVG' && r.name !== '–ö–æ–ª. –≤–∞–≥–æ–Ω–æ–≤ (—Å—Ä–µ–¥–Ω–µ–µ)'
  );
  fillSimpleTable('budgetProdRevAvgBody', revenueAvgFiltered);
   // --- –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è —Å–ª—É–∂–±–∞: –º–∞—Ä–∂–∞ –∏ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –≤–∞–≥–æ–Ω–∞ ---
  const commMonthsEl  = document.getElementById('budgetCommMonths');
  const commSummaryEl = document.getElementById('budgetCommSummary');
  const commYieldEl   = document.getElementById('budgetCommYield');

  if (budgetCommercial && commMonthsEl && commSummaryEl) {
    const cPeriod = budgetCommercial.period || {};
    const m = cPeriod.month;
    const y = cPeriod.year;
    const monthsTotalComm = cPeriod.monthsTotal || m;

    // –ü–æ–¥–ø–∏—Å—å "–ë—é–¥–∂–µ—Ç 2025 –≥., 10 –º–µ—Å. (–ø–æ –æ–∫—Ç—è–±—Ä—é)" ‚Äî –ø–æ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–π —Å–ª—É–∂–±–µ
    let headerText = '';
    if (m && y) {
      const monthName = monthsNames[m - 1] || '';
      if (monthsTotalComm && monthsTotalComm !== m) {
        headerText = `–ë—é–¥–∂–µ—Ç ${y} –≥., ${monthsTotalComm} –º–µ—Å. (–ø–æ ${monthName})`;
      } else {
        headerText = `–ë—é–¥–∂–µ—Ç ${y} –≥. (–ø–æ ${monthName})`;
      }
    }
    commMonthsEl.textContent = headerText;

    // –ú–∞—Ä–∂–∞: –ø–ª–∞–Ω / —Ñ–∞–∫—Ç, –≤ –º–ª–Ω —Ä—É–±
    const margin = budgetCommercial.margin || {};
    const planVal = margin.plan ?? null;
    const factVal = margin.fact ?? null;

    if (planVal === null && factVal === null) {
      commSummaryEl.textContent = '‚Äî / ‚Äî';
    } else {
      const planText = planVal !== null ? formatMillions(planVal) : '‚Äî';
      const factText = factVal !== null ? formatMillions(factVal) : '‚Äî';

      const factBad = planVal != null && factVal != null && factVal > planVal;

      commSummaryEl.innerHTML =
        `${planText} / ` +
        `<span class="${factBad ? 'text-negative' : ''}">${factText}</span> –º–ª–Ω. —Ä.`;
    }

    // –î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –≤–∞–≥–æ–Ω–∞: –ø–ª–∞–Ω / —Ñ–∞–∫—Ç, —Ä—É–±./–≤–∞–≥.-—Å—É—Ç.
    if (commYieldEl) {
      const yPlan = margin.yieldPlan;
      const yFact = margin.yieldFact;

      if (yPlan == null && yFact == null) {
        commYieldEl.textContent = '‚Äî / ‚Äî';
      } else {
        const planText = yPlan != null
          ? formatNumber(Math.round(yPlan))
          : '‚Äî';
        const factText = yFact != null
          ? formatNumber(Math.round(yFact))
          : '‚Äî';

        // –î–ª—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ "–ø–ª–æ—Ö–æ", –∫–æ–≥–¥–∞ —Ñ–∞–∫—Ç –ú–ï–ù–¨–®–ï –ø–ª–∞–Ω–∞
        const factBadYield = yPlan != null && yFact != null && yFact < yPlan;

        commYieldEl.innerHTML =
          `${planText} / ` +
          `<span class="${factBadYield ? 'text-negative' : ''}">${factText}</span> —Ä—É–±./–≤–∞–≥.-—Å—É—Ç.`;
      }
    }
  } else {
    if (commSummaryEl) commSummaryEl.textContent = '‚Äî / ‚Äî';
    if (commYieldEl)   commYieldEl.textContent   = '‚Äî / ‚Äî';
  }

  // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ä–µ–Ω–¥–µ—Ä–µ
  const prodPanel = document.getElementById('budgetProdPanel');
  if (prodPanel) prodPanel.classList.add('hidden');

  const commPanel = document.getElementById('budgetCommPanel');
  if (commPanel) commPanel.classList.add('hidden');
}

function populateDashboard() {
    if (!dashboardData) return;

    // --- –ü–æ–≥—Ä—É–∑–∫–∞ ---
    document.getElementById('loadedWagonsMonth').textContent =
        formatNumber(dashboardData.loading.loaded_wagons_month);
    document.getElementById('progressPercent').textContent =
        `${dashboardData.loading.progress_percent}%`;
    document.getElementById('progressFill').style.width =
        `${dashboardData.loading.progress_percent}%`;
    document.getElementById('planMonth').textContent =
        formatNumber(dashboardData.loading.plan_month);
    document.getElementById('fullMonthPlan').textContent =
        formatNumber(dashboardData.loading.month_total_plan || 0);
    document.getElementById('loadedYesterday').textContent =
        formatNumber(dashboardData.loading.loaded_wagons_yesterday);
    renderYesterdayLoadingList();

    // --- –ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å ---
    document.getElementById('totalDebt').textContent =
        formatCurrency(dashboardData.receivables.total_debt);
    document.getElementById('overdueDebt').textContent =
        formatCurrency(dashboardData.receivables.overdue_debt);
    document.getElementById('overduePercent').textContent =
        `${dashboardData.receivables.overdue_percent}%`;
    document.getElementById('overdueProgressFill').style.width =
        `${dashboardData.receivables.overdue_percent}%`;

    // –ü–æ–¥–ø–∏—Å—å –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º "–î–µ–±–∏—Ç–æ—Ä—Å–∫–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å"
    const dateEl = document.getElementById('receivablesDate');
    if (dateEl) {
      if (dashboardData.receivables_date) {
        dateEl.textContent =
          '–î–∞–Ω–Ω—ã–µ –Ω–∞ ' + formatDateRuShort(dashboardData.receivables_date);
      } else {
        dateEl.textContent = '';
      }
    }

    // --- –û—Å—Ç–∞—Ç–∫–∏ –¥–µ–Ω–µ–∂–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ –≤ —à–∞–ø–∫–µ –∫–∞—Ä—Ç–æ—á–∫–∏ ---
    const cashEl = document.getElementById('cashSummary');
    if (cashEl && dashboardData.cash) {
      const textAmount = formatCurrency(dashboardData.cash.total);
      const textDate = dashboardData.cash.date
        ? formatDateRuShort(dashboardData.cash.date)
        : '';
      cashEl.textContent = textDate
        ? `–û—Å—Ç–∞—Ç–∫–∏ –î–°: ${textAmount} –Ω–∞ ${textDate}`
        : `–û—Å—Ç–∞—Ç–∫–∏ –î–°: ${textAmount}`;
    }

    // --- –ö—Ä–µ–¥–∏—Ç–æ—Ä—Å–∫–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å ---
    const payDateEl = document.getElementById('payablesDate');
    if (payDateEl) {
      payDateEl.textContent = dashboardData.payables_date
        ? '–î–∞–Ω–Ω—ã–µ –Ω–∞ ' + formatDateRuShort(dashboardData.payables_date)
        : '';
    }

    // –ë–ª–æ–∫ –ö—Ä–µ–¥–∏—Ç–æ—Ä–∫–∞: —Ü–∏—Ñ—Ä—ã —Å–≤–µ—Ä—Ö—É (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–±—â–∏–π –¥–æ–ª–≥)
    const apTotalEl = document.getElementById('apTotalDebt');
    if (apTotalEl && dashboardData.payables) {
        const totalAp = dashboardData.payables.total_debt || 0;
        apTotalEl.textContent = formatCurrency(totalAp);
    }

    // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫—Ä–µ–¥–∏—Ç–æ—Ä–∫–∏ –ø–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º
    renderPayablesSuppliers();

    // –ï—â—ë —Ä–∞–∑ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –≤—ã—Å—Ç–∞–≤–ª—è–µ–º –¥–∞—Ç—É –¥–ª—è –¥–µ–±–∏—Ç–æ—Ä–∫–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    if (dateEl) {
        if (dashboardData.receivables_date) {
            dateEl.textContent = '–î–∞–Ω–Ω—ã–µ –Ω–∞ ' + formatDateRuShort(dashboardData.receivables_date);
        } else {
            dateEl.textContent = '';
        }
    }

    // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—Å—Ä–æ—á–∫–∏ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º
    renderReceivablesByClient();

    // --- –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è (–æ–±—â–∞—è —Å—É–º–º–∞ + —Ç–∞–±–ª–∏—Ü–∞ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º) ---
    if (paymentsByClient && paymentsByClient.length) {
        const totalPayments = paymentsByClient.reduce(
            (sum, p) => sum + (p.amount || 0), 0
        );
        updatePaymentsTotal(totalPayments);
        renderPaymentsByClient(paymentsByClient);
    } else {
        updatePaymentsTotal(0);
        renderPaymentsByClient([]);
    }

    // --- –ë—é–¥–∂–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–π —Å–ª—É–∂–±—ã ---
    renderBudgetProductionCard();

    // --- –†–µ–º–æ–Ω—Ç—ã ---
    document.getElementById('fleetTotal').textContent =
        formatNumber(dashboardData.repairs.fleet_total);

    document.getElementById('lastUpdate').textContent =
        dashboardData.period_label || '‚Äî';
}


// ==========================
// 7. –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–û –ö–ù–û–ü–ö–ï
// ==========================

async function refreshData() {
    const btn = document.querySelector('.refresh-btn');
    if (btn) btn.disabled = true;

    try {
        await loadDataFromSheet();
        populateDashboard();

        // —Å—Ç–∞–≤–∏–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        const updatedEl = document.getElementById('dataUpdatedAt');
        if (updatedEl) {
            const now = new Date();
            updatedEl.textContent = '–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ' + formatUpdatedAt(now);
        }

        if (btn) {
            btn.textContent = '‚úì –û–±–Ω–æ–≤–ª–µ–Ω–æ!';
            setTimeout(() => {
                btn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
                btn.disabled = false;
            }, 1500);
        }
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', e);
        const updatedEl = document.getElementById('dataUpdatedAt');
        if (updatedEl) {
            updatedEl.textContent = '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö';
        }
        const lastUpdEl = document.getElementById('lastUpdate');
        if (lastUpdEl) {
            lastUpdEl.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
        }
        if (btn) {
            btn.textContent = '–û—à–∏–±–∫–∞ üòï';
            setTimeout(() => {
                btn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
                btn.disabled = false;
            }, 2000);
        }
    }
}

// === –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è: —Ä–µ–Ω–¥–µ—Ä —Å—É–º–º—ã –∏ —Å–ø–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ ===

// –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —Å—É–º–º—É –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É (–æ–±—â–∞—è)
function updatePaymentsTotal(sum) {
  const el = document.getElementById('paymentsTotal');
  if (!el) return;
  el.textContent = formatMillions(sum) + ' –º–ª–Ω. —Ä.';
}

// –†–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ã –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º
function renderPaymentsByClient(paymentsData) {
  const panel = document.getElementById('clientsPaymentsPanel');
  const tbody = document.getElementById('clientsPaymentsBody');
  const toggle = document.getElementById('toggleClientsPayments');

  if (!panel || !tbody || !toggle) return;

  tbody.innerHTML = '';

  if (!paymentsData || !paymentsData.length) {
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 3;
    td.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è—Ö –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º.';
    td.style.fontSize = '12px';
    td.style.color = 'var(--text-secondary)';
    tr.appendChild(td);
    tbody.appendChild(tr);
    return;
  }

  const total = paymentsData.reduce((sum, r) => sum + (r.amount || 0), 0);

  paymentsData.forEach(row => {
    const tr = document.createElement('tr');

    const tdClient = document.createElement('td');
    tdClient.textContent = row.client;
    tr.appendChild(tdClient);

    const tdAmount = document.createElement('td');
    tdAmount.className = 'amount';
    tdAmount.textContent = formatMillions(row.amount) + ' –º–ª–Ω. —Ä.';
    tr.appendChild(tdAmount);

    const tdPercent = document.createElement('td');
    tdPercent.className = 'percent';
    const p = total ? Math.round((row.amount / total) * 100) : 0;
    tdPercent.textContent = p + '%';
    tr.appendChild(tdPercent);

    tbody.appendChild(tr);
  });
}

// === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è ===
document.addEventListener('DOMContentLoaded', () => {
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏ –≤ —à–∞–ø–∫–µ
  updateDateTime();
  setInterval(updateDateTime, 60 * 1000);

  // –ö–Ω–æ–ø–∫–∞ "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—Å—Ä–æ—á–∫–∏ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º"
  const overdueBtn = document.getElementById('toggleClientsOverdue');
  const overduePanel = document.getElementById('clientsOverduePanel');
  if (overdueBtn && overduePanel) {
    overdueBtn.addEventListener('click', () => {
      overduePanel.classList.toggle('hidden');
    });
  }

  // –ö–Ω–æ–ø–∫–∞ "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫—Ä–µ–¥–∏—Ç–æ—Ä–∫–∏ –ø–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º"
  const suppliersBtn = document.getElementById('toggleSuppliersPayables');
  const suppliersPanel = document.getElementById('suppliersPayablesPanel');
  if (suppliersBtn && suppliersPanel) {
    suppliersBtn.addEventListener('click', () => {
      suppliersPanel.classList.toggle('hidden');
    });
  }

  // –ö–Ω–æ–ø–∫–∞ "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ —Ä–µ–º–æ–Ω—Ç–∞–º"
  const repairsBtn = document.getElementById('toggleRepairsTable');
  const repairsPanel = document.getElementById('repairsTablePanel');
  if (repairsBtn && repairsPanel) {
    repairsBtn.addEventListener('click', () => {
      repairsPanel.classList.toggle('hidden');
    });
  }

  // –í—á–µ—Ä–∞—à–Ω—è—è –ø–æ–≥—Ä—É–∑–∫–∞: –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ —Å—Ç–∞–Ω—Ü–∏—è–º
  const yestBtn = document.getElementById('toggleLoadingYesterday');
  const yestPanel = document.getElementById('loadingYesterdayPanel');
  if (yestBtn && yestPanel) {
    yestBtn.addEventListener('click', () => {
      yestPanel.classList.toggle('hidden');
    });
  }

  // –ë—é–¥–∂–µ—Ç: —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–µ–π "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è / –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è —Å–ª—É–∂–±–∞"
  const budgetProdBtn = document.getElementById('toggleBudgetProd');
  const budgetProdPanel = document.getElementById('budgetProdPanel');
  if (budgetProdBtn && budgetProdPanel) {
    budgetProdBtn.addEventListener('click', () => {
      budgetProdPanel.classList.toggle('hidden');
    });
  }

  const budgetCommBtn = document.getElementById('toggleBudgetComm');
  const budgetCommPanel = document.getElementById('budgetCommPanel');
  if (budgetCommBtn && budgetCommPanel) {
    budgetCommBtn.addEventListener('click', () => {
      budgetCommPanel.classList.toggle('hidden');
    });
  }

  // –ö–Ω–æ–ø–∫–∞ "–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º"
  const paymentsBtn = document.getElementById('toggleClientsPayments');
  const paymentsPanel = document.getElementById('clientsPaymentsPanel');
  if (paymentsBtn && paymentsPanel) {
    paymentsBtn.addEventListener('click', () => {
      paymentsPanel.classList.toggle('hidden');
    });
  }

  // –°—Ä–∞–∑—É –≥—Ä—É–∑–∏–º –¥–∞–Ω–Ω—ã–µ
  refreshData();
});

</script>
</body>
</html>
